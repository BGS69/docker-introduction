<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>Introduction to Docker - Catalyst Training</title>

        <meta name="author" content="Catalyst">

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/catalyst.css" id="theme">
        <link rel="stylesheet" href="css/font-awesome.css">
        <link rel="stylesheet" href="css/asciinema-player.css">

        <!-- For syntax highlighting -->
        <!--<link rel="stylesheet" href="lib/css/zenburn.css">-->
        <link rel="stylesheet" href="lib/css/solarized-light.css">

        <!-- If the query includes 'print-pdf', include the PDF print sheet -->
        <script>
            if( window.location.search.match( /print-pdf/gi ) ) {
                var link = document.createElement( 'link' );
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
                document.getElementsByTagName( 'head' )[0].appendChild( link );
            }
        </script>

        <style>
            /* Add the ability to omit slides from the printed version (has to be after the print include)*/
            @media print {
                .reveal .slides section.no-print {
                    display: none !important;
                    visibility: hidden !important;
                }
            }
        </style>
        <style>
            .reveal h1, .reveal h2, .reveal h3 {
                color: #ba2025;
            }
        </style>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->

        <!-- Please put any custom styles here -->
        <style>

        </style>
    </head>

    <body>

        <div class="reveal">

            <!-- Any section element inside of this container is displayed as a slide -->
            <div class="slides">
                <!-- Cover slide -->
                <section>
                    <h1 class="catalyst-logo">Catalyst</h1>
                    <h3>Intro to Docker</h3>
                    <p class="small-text">
                        Presented by <a href="#">Travis Holton</a>
                    </p>
                </section>

                <section>
                    <h3>Administrivia</h3>
                    <ul>
                      <li>Bathrooms</li>
                      <li>Fire exits</li>
                    </ul>
                </section>

                <section>
                    <h3>This course</h3>
                    <ul>
                        <li>Makes use of official Docker docs</li>
                        <li>Based on latest Docker</li>
                        <li>A mix of command line and theory</li>
                        <li>Assumes no prior Docker knowledge</li>
                        <li>Assumes familiarity with the linux shell</li>
                        <li>Assumes we are using ubuntu 14.04 (trusty)</li>
                    </ul>
                    <aside class="notes">
                        Introductory course so we'll start out with basic material
                        that some people may already be familiar with.
                    </aside>
                </section>

                <section>
                    <h3>Aims</h3>
                    <ul>
                        <li>Understand how to use Docker on the command line</li>
                        <li>Understand how Docker works</li>
                        <li>Learn how to integrate Docker with applications</li>
                        <li>Learn ops and developers can use Docker to deploy
                        applications</li>
                        <li>Get people thinking about where they could use Docker</li>
                    </ul>
                
                    <aside class="notes">
                        think about how you can use docker in dev, testing,
                        deploying code
                    </aside>
                </section>

                <section>
                    <section>
                        <h2>Setup</h2>
                    </section>
                    <section>
                        <h3>Fetch course resources</h3>
                        <pre class="fragment" data-fragment-index="0"><code>$ git clone \
   https://github.com/catalyst-training/docker-introduction.git
$ cd docker-introduction</code></pre>
                        <pre class="fragment" data-fragment-index="0"><code>$ cd ~/docker-introduction
$ ls</code></pre>
                        <ul style="width:80%;">
                            <li class="fragment" data-fragment-index="1">Slides for Reveal.js presentation</li>
                            <li class="fragment" data-fragment-index="2">docker-introduction.pdf</li>
                            <li class="fragment"
                                data-fragment-index="3">Ansible setup playbook</li>
                            <li class="fragment" data-fragment-index="4">Sample code for some exercises</li>
                        </ul>


                    </section>
                    <section>
                        <h3>Ansible</h3>
                        <ul>
                          <li>
                            Some of the features we will be exploring require
                            setup. We'll use ansible for that.
                          </li>
                            <li>Python based tool set</li>
                            <li>Automate devops tasks
                                <ul>
                                    <li>server/cluster management </li>
                                    <li>installing packages</li>
                                    <li>deploying code </li>
                                    <li>managing config</li>
                                </ul>
                        </ul>
                    </section>
                    <section>
                        <h3>Setup Ansible</h3>
                        <pre class="fragment" data-fragment-index="0"><code>$ git clone https://github.com/catalyst/catalystcloud-ansible.git</code></pre>
                        <pre class="fragment" data-fragment-index="1"><code>$ cd ~/catalystcloud-ansible
$ ./install-ansible.sh
. 
. &lt;stuff happens&gt;
.
$ source $CC_ANSIBLE_DIR/ansible-venv/bin/activate</code></pre>
                        <ul style="width:80%;" class="fragment" data-fragment-index="2">
                            <li>Installs python virtualenv with latest ansible
                            libraries</li>
                            <li>We'll be using this virtualenv for tasks
                                throughout the course.</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Setup Docker</h3>
                        <ul style="width:80%;">
                            <li class="fragment" data-fragment-index="0">
                                Follow instructions on website for installing
                                <ul>
                                    <li><a href="https://store.docker.com/search?offering=community&type=edition">Docker Community Edition</a></li>
                                    <li><a href="https://docs.docker.com/compose/install/">docker-compose</a></li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="1">If
                                you are using Ubuntu, use the ansible playbook included in course repo</li>
                        </ul>
                        <pre class="fragment" data-fragment-index="1"><code>$ cd docker-introduction
$ ansible-playbook -K ansible/docker-install.yml \
      -e ansible_python_interpreter=/usr/bin/python</code></pre>
                        <ul style="width:80%;">
                            <li class="fragment" data-fragment-index="2">
                                This playbook installs:
                                <ul>
                                    <li class="fragment"
                                        data-fragment-index="3">latest Docker <em>Community Edition</em></li>
                                    <li class="fragment"
                                        data-fragment-index="4"><code>docker-compose</code></li>
                                    <li class="fragment"
                                        data-fragment-index="4">Note: you
                                        might need to logout and login again
                                    </li>
                                </ul>
                            </li>
                        </ul>
                        
                        
                    </section>
                    
                    <section>
                        <h3>Fetch and run slides</h3>
                      <pre><code>$ docker run --name docker-intro -d --rm \
        -p 8000:8000 heytrav/docker-introduction-slides</code></pre>
<!--<asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1" theme="solarized-light" src="lib/asciicast-119477.json" cols="150" rows="15"></asciinema-player>-->
<p>
Follow along with course slides: <a href="http://localhost:8000">http://localhost:8000</a>
</p>
                    </section>
                </section>

                
                  <section>

                    <section>
                      <h2>
                        Introduction to containers
                      </h2>
                    </section>

                  <section>
                      <h3>What is containerization?</h3>
                      <ul>
                        <li>
                          A type of virtualization
                        </li>
                          
                          <li>Difference from traditional VMs
                            <ul>
                              <li>Don't replicate entire OS, just bits needed for application</li>
                              <li>Run natively on host</li>
                            </ul>
                          </li>
                          <li>
                              Key benefits:
                              <ul>
                                  <li>More lightweight than VMs</li>
                                  <li>Efficiency gains in storage, CPU</li>
                                  <li>Portability
                                      <aside class="notes">
                                          Same application container can run on any system or cloud.
                                      </aside>
                                  </li>
                              </ul>
                          </li>
                      </ul>
                      <aside class="notes">
                          
                        <ul>
                          <li>
                            Containers are a method of operating system virtualization that allow you to run an application and its dependencies in resource-isolated processes.
                          </li>
                          <li>Seem like traditional vms but...</li>
                        </ul>
                      </aside>
                      
                      
                  </section>

                  <section class="image-slide">
                      <h2>Lightweight</h2>
                      <img src="img/docker.png" alt="">
                      <aside class="notes">
                          <ul>
                              <li>Virtual machines run guest operating systems (note OS layer)</li>
                              <li>Resource intensive</li>
                              <li>
                                  Resulting disk image and application state entanglement of
                                  <ul>
                                      <li>OS Settings</li>
                                      <li>System dependencies</li>
                                      <li>OS patches</li>
                                  </ul>
                              </li>
                          </ul>
                      </aside>
                  </section>
                  <section>
                      <h3>
                          Benefits of Containers: Resources
                      </h3>
                      <ul>
                          <li>Containers share a kernel</li>
                          <li>Use less CPU than VMs</li>
                          <li>Less storage. Container image only contains:
                              <ul>
                                  <li>executable</li>
                                  <li>application dependencies</li>
                              </ul>
                          </li>
                      </ul>
                  </section>

                <section>
                    <h3>Benefits of Containers: Decoupling</h3>
                    <div style="float:left;width:50%"><ul>
                        <li>Application stack not coupled to host machine</li>
                        <li>Scale and upgrade services independently</li>
                        <li>Treat services like cattle instead of pets </li>
                      </ul></div>
                      <div style="float:left;width:50%"><img src="img/immutable_infrastructure.gif" /></div>
                    <aside class="notes">Scale services, not machines. You *can* treat machines like cattle, not pets.</aside>
                </section>
                <section>
                    <h3>Benefits of Containers: Workflows</h3>
                    <ul>
                      <li>Easy to distribute</li>
                      <li>Developers can wrap application with libs and dependencies as a single package </li>
                      <li>
                        Easy to move code from development environments to
                        production in easy and replicable fashion 
                      </li>
                    </ul>
                </section>
                  </section>
                  <section>
                    <section>
                      <h2>
                        Introduction to Docker
                      </h2>
                      <h3>The Docker Platform</h3>
<aside class="notes">
                            An open-source platform for creating,
                            running, and distributing software "containers"
                            that bundle software applications with all of
                            their dependencies.
                        </aside>
                    </section>

                    <section>
                      <h3>What is Docker?</h3>
                      <dl>
                        <dt>High level</dt>
                        <dd>
                        An open-source platform for creating,
                        running, and distributing software <em>containers</em>
                        that bundle software applications with all of
                        their dependencies.
                        </dd>
                        <dt>Low level</dt>
                        <dd>
                        A command-line tool for programmatically defining the contents of a Linux container in code, which can then be versioned, reproduced, shared, and modified easily just as if it were the source code to a program
                        </dd>
                      </dl>
                    </section>
                    
                    <section>
                        <h3>Docker popularity</h3>
                        <ul>
                            <li class="fragment" data-fragment-index="0">Linux containers are not new
                              <ul>
                                <li>FreeBSD Jails</li>
                                <li>LXC containers</li>
                                <li>Solaris Zones</li>
                              </ul>
                              </li>
                              <li class="fragment" data-fragment-index="1">Docker is doing for containers what Vagrant did for virtual machines
                                <ul>
                                  <li>Easy to create</li>
                                  <li>Easy to distribute</li>
                                </ul>
                              </li>
                        </ul>
                    </section>

                    <section>
                        <h3>Docker workflow</h3>
                        
                        <ul>
                            <li class="fragment" data-fragment-index="0">Developer packages application and supporting components into image</li>
                            <li class="fragment" data-fragment-index="1">Developer/CI pushes image to private or public registry</li>
                            <li class="fragment" data-fragment-index="2">The image becomes the unit for distributing and testing your application.  </li>
                        </ul>
                      <img  class="fragment" data-fragment-index="2"src="img/Diapositive1.png" alt="Developer workflow">
                        <aside class="notes">
                            <p>
                            Docker has created a platform that makes it easy
                            to create and distribute containerised
                            applications
                            </p>
                        
                        <p>
                        The collective tooling that enables you to...
                        </p>    <ul>
                                <li>Provides the ability to package and run an application in a loosely
                                isolated environment called a container. </li>
                                <li>The isolation and security allow you to run many containers simultaneously on a given host. </li>
                                <li>They don’t need the extra load of a hypervisor, but run directly within the host machine’s kernel. </li>
                                <li>Can run more containers on a given hardware combination than using virtual machines.</li>
                            </ul>
                        </aside>

                    </section>
                    <!--<section>
                        <h3>The Docker Engine</h3>
                        <aside class="notes">
                            <p>
                            Client server application
                            </p>
                            <p>
                            The CLI uses the Docker REST API to control or
                            interact with the Docker daemon through scripting or
                            direct CLI commands. Many other Docker applications
                            use the underlying API and CLI.
                            </p>
                            <p>
                            The daemon creates and manages Docker objects, such as
                            images, containers, networks, and volumes.
                            </p>
                        </aside>
                        <ul>
                            <li>A server which is a type of long-running program called a daemon process (the dockerd command).</li>
                            <li>A REST API which specifies interfaces that programs can use to talk to the daemon and instruct it what to do.</li>
                            <li>A command line interface (CLI) client (the docker command).</li>
                        </ul>
                        <img src="img/engine-components-flow.png" alt="Docker Engine">
                    </section>-->
                    <!--<section>
                        <h3>Uses of Docker</h3>
                        <ul>
                            <li>Fast consistent delivery of applications </li>
                            <li>Responsive deployment and scaling</li>
                            <li>Running more workloads on same hardware</li>
                        </ul>
                        <aside class="notes">
                            <ul>
                                <li>Standardised environment across development, testing, production</li>
                                <li>Ideal for CI/CD workflows</li>
                                <li>Containers can run on multiple environments</li>
                                <li>Portability and Lightweight make scaling easy</li>
                                <li>Can run more on the same hardware</li>
                            </ul>
                        </aside>
                    </section>-->
                  

                    <section>
                        <h3>Docker Portability</h3>

                        <ul>
                            <li>Most modern operating systems
                                <ul>
                                    <li>Linux (RHEL, CentOS, Ubuntu LTS, etc.)</li>
                                    <li>OSX </li>
                                    <li>Windows</li>
                                </ul>
                            </li>
                            <li>Lightweight Docker optimized Linux distributions (CoreOS, Project Atomic, RancherOS, etc.)</li>
                            <li>Private clouds (OpenStack, Vmware)</li>
                            <li>Public clouds (AWS, Azure, Rackspace, Google)</li>
                        </ul>

                    </section>


                  </section>
                <section>
                    <section>
                        <h2>First Steps with Docker</h2>
                    </section>
                  <section>
                      <h3>
                          Docker version
                      </h3>

                      <pre><code>$ docker --version
Docker version 17.03.1-ce, build c6d412e</code></pre>
                      <p>Current version scheme similar to Ubuntu versioning: <code>YY.MM.#</code></p>
                    
                  </section>
                  <section>
                      <h3>Get command documentation</h3>
                      <ul>
                          <li>Just typing <code style="color:red;">docker</code> returns list of commands</li>
                          <li>Comprehensive online docs on <a href="https://docs.docker.com/edge/engine/reference/commandline/docker/">Docker website</a></li>
                      </ul>
<pre><code>$ docker&lt;ENTER&gt;

    Usage:  docker COMMAND

    A self-sufficient runtime for containers

    Options:
          --config string      Location of client config files (default "/Users/travis/.docker")
      -D, --debug              Enable debug mode
          --help               Print usage
    .
    .</code></pre>
                  </section>
                    <section>
                      <h3>
                        Basic client usage
                      </h3>
                          <code>docker</code> <code
                                                              style="color:red">command</code> <code
                                                              style="color:blue;font-style:italic">[options] [args]</code>
                      
                      
                      <ul style="width:70%;">
                      <li>Calling any command with <code style="color:red;">--help</code> displays some docs</li>
                      </ul>
                    </section>
                    
                  <section>
                     <h4>Exercise: View documentation for <code>docker run</code></h4>
                    <pre class="fragment" data-fragment-index="0"><code>$ docker run --help
Usage:  docker run [OPTIONS] IMAGE [COMMAND] [ARG...]

Run a command in a new container

Options:
      --add-host list                  Add a custom host-to-IP mapping (host:ip)
  -a, --attach list                    Attach to STDIN, STDOUT or STDERR
      --blkio-weight uint16            Block IO (relative weight), between 10 and 1000, or 0 to disable (default 0)
      --blkio-weight-device list       Block IO weight (relative device weight) (default [])
      .
      .  </code></pre>
                  </section>
<section>
                        <h3>
                            Search for images
                        </h3>
                        <p>
                        <code>docker search </code><code style="color:blue;">[OPTIONS]</code><code style="color:red;"> TERM</code> 
                        </p>
                        <table class="fragment" data-fragment-index="0">
                          <tr>
                            <th>Option</th>
                            <th>Argument</th>
                            <th>Description </th>
                          </tr>



  <tr><td>-f, --filter     </td><td>filter </td><td>  Filter output based on conditions provided</td></tr>
  <tr><td>    --format     </td><td>string </td><td>  Pretty-print search using a Go template</td></tr>
  <tr><td>    --help       </td><td>       </td><td>   Print usage</td></tr>
  <tr><td>    --limit      </td><td>int    </td><td>   Max number of search results (default 25)</td></tr>
  <tr><td>    --no-trunc   </td><td>       </td><td>  Don't truncate output</td></tr>
                        </table>
<asciinema-player class="fragment" data-fragment-index="1" autoplay="0" loop="loop"  font-size="medium" speed="1"
     theme="solarized-light" src="lib/docker-search.json" cols="200" rows="10"></asciinema-player>

                    </section>
                    <section>
                        <h3>
                            Pull an image from a registry
                        </h3>
                        <p>
                        <code>docker pull </code><code
                            style="color:blue;">[OPTIONS]</code><code
                            style="color:red;"> NAME</code><code style="color:blue;">[:TAG]</code> 
                        </p>
                        <table class="fragment" data-fragment-index="0">
                          <tr>
                            <th>Option</th>
                            <th>Argument</th>
                            <th>Description </th>
                          </tr>


                        <tr><td>-a, --all-tags              </td><td>  </td><td>Download all tagged images in the repository</td></tr>
                        <tr><td>    --disable-content-trust </td><td>  </td><td>Skip image verification (default true)</td></tr>
                        <tr><td>    --help                  </td><td>  </td><td>Print usage</td></tr>

                        </table>
<asciinema-player class="fragment" data-fragment-index="1" autoplay="0" loop="loop"  font-size="medium" speed="1"
     theme="solarized-light" src="lib/docker-pull.json" cols="200" rows="10"></asciinema-player>
                    </section>

                  <section>
                    <h3><code>docker run</code></h3> 
                    <h4>Run a command in a container from an image
                    </h4>                        
                    <p>
                        <code>docker</code> <code >run</code>
                        <code style="color:purple">[options]</code> <code
                        style="color:red;font-style:italic">image</code> <code style="color:blue;font-style:italic">[command]</code>
                        </p>
                        <ul class="fragment" data-fragment-index="0">
                            <li>
                                <code>docker run</code> requires an <code style="color:red">image</code> argument
                            </li>
                        </ul>
                        
                        <table class="fragment" data-fragment-index="1">
                          <tr>
                            <th>Option</th>
                            <th>Argument</th>
                            <th>Description </th>
                          </tr>
                          <tr><td>-i     </td><th>         </th>      <td>Keep STDIN open</td></tr>
                          <tr><td>-t     </td><th>         </th>      <td>Allocate a tty</td></tr>
                          <tr><td>--rm   </td><th>         </th>      <td>Automatically remove container on exit</td></tr>
                          <tr><td>-v     </td><th>  list   </th>      <td>Mount a volume</td></tr>
                          <tr><td>-p     </td><th>  list   </th>      <td>List of port mappings</td></tr>
                          <tr><td>-e, --env     </td><th>  list   </th>
                            <td>Set environment variables</td></tr>
                          <tr><td>-d, --detach     </td><th></th>      <td>Run
                            container in background and print container ID</td></tr>
                          <tr><td>--link </td><th>  list   </th>      <td>Add link to another container</td></tr>
                          <tr><td>--name </td><th>  string </th>      <td>Name for the container</td></tr>
                        </table>
                        <p class="fragment" data-fragment-index="1">
                       These are just
                        examples that we'll use in the course. 
                        See complete
                        list with <code>docker run --help</code>
                        </p>
                        
                  </section>

                    <section>
                        <h3>
                            Run a simple container
                        </h3>
                        <pre><code>$ docker run hello-world</code></pre>
<asciinema-player autoplay="1" loop="loop" font-size="medium" speed="1"
    theme="solarized-light" src="lib/asciicast-122666.json" cols="150" rows="10"></asciinema-player>
<ul>
    <li class="fragment" data-fragment-index="0">
        The hello-world image was created by docker for instructional purposes. It
        just outputs a <em>hello world</em>-like message and exits.
    </li>
    
</ul>


                    </section>
                    

                    
                  <section>
                    <h3>
                      Start a shell
                    </h3>
                      <p>
                      <code>docker</code> <code >run</code>
                      <code style="color:green;">image</code>
                      <code style="color:blue;font-style:italic">[command]</code>
                      </p>
                     <pre><code>$ docker run alpine /bin/sh</code></pre> 
<asciinema-player class="fragment" data-fragment-index="0" autoplay="0" loop="loop"  font-size="medium" speed="1"
     theme="solarized-light" src="lib/asciicast-119489.json" cols="174" rows="3"></asciinema-player>                    <ul>
                      <li class="fragment" data-fragment-index="1">Docker
                          starts container using alpine image</li>
  <li class="fragment" data-fragment-index="2">
 The <em>alpine</em> image contains the <a
     href="https://www.aplinelinux.org/about/">Alpine OS</a>, a very minimal
 Linux distribution. 
 </li>                      <li class="fragment" data-fragment-index="3">
                            <code >[command]</code> argument is executed
                            inside container
                            
                        </li>
                      <li class="fragment" data-fragment-index="4">Exits immediately</li>
                      <li class="fragment" data-fragment-index="5">A docker container only runs as long as it has a process (eg. a shell terminal or program) to run</li>
 

                    </ul>
 
                  </section>



                    
                  <section>
                    
<h4>Exercise: Start an <em>interactive</em> shell</h4>
                      <p>
                      <code>docker</code> <code >run</code> <code style="color:red;">[options]</code> <code >alpine</code> <code>/bin/sh</code>
                      </p>
                      <p>
                      Find <code>[options]</code> to make container run interactively
                      </p>
                    <pre class="fragment" data-fragment-index="0"><code>$ docker run -it alpine /bin/sh</code></pre>
<asciinema-player class="fragment" data-fragment-index="0" autoplay="1" loop="loop"  font-size="medium" speed="1"
    theme="solarized-light" src="lib/asciicast-119490.json" cols="174" rows="5"></asciinema-player>
                    <ul style="width:80%;">
                      <li class="fragment" data-fragment-index="0">Docker starts alpine image
                        <ul>
                          <li><code>-i</code> interactively</li>
                          <li><code>-t</code> allocate a pseudo-TTY</li>
                        </ul>
                      </li>
                      <li class="fragment" data-fragment-index="1">Runs shell command</li>
                      <li class="fragment" data-fragment-index="2">Execute commands inside container</li>
                          <li class="fragment" data-fragment-index="3">
                              Exiting the shell stops the process and the
                              container
                          </li>
                    </ul>
                  </section>
                  <section>
                    <h3>List running containers</h3>
                    <h4><code>docker ps</code></h4>
                    <pre  class="fragment" data-fragment-index="0"
                    style="width:100%"><code>$ docker ps
                    
CONTAINER ID  IMAGE                                ... NAMES
b3169acf49f8  alpine                               ... adoring_edison
02aa3e50580c  heytrav/docker-introduction-slides   ... docker-intro</code></pre>
                    <p class="fragment" data-fragment-index="1">
                    Note: by default docker will assign a random name to each
                    container (i.e. <em>adoring_edison</em>).
                    </p>
                        
   <table class="fragment" data-fragment-index="2">
     <tr>
       <th>Option                  </th>
       <th>Argument</th>
       <th>Description</th>
     </tr>

     <tr><td><code>-a, --all      </code></td><td>            </td><td> Show all containers (default shows just running)</td></tr>
     <tr><td><code>-f, --filter   </code></td><td> filter     </td><td>    Filter output based on conditions provided</td></tr>
     <tr><td><code>    --format   </code></td><td> string     </td><td>    Pretty-print containers using a Go template</td></tr>
     <tr><td><code>    --help     </code></td><td>            </td><td> Print usage</td></tr>
     <tr><td><code>    --no-trunc </code></td><td>            </td><td> Don't truncate output</td></tr>
   </table>
                    
                  </section>
                  <section>
                      <h4>
                          Exercise: Assign the name <em>myalpine</em> when running
                          previous example container
                      </h4>
                      
                      <p>Hint: <code>docker run -it </code><code style="color:red;">&lt;option&gt;</code><code> alpine</code></p>
                    <pre class="fragment" style="width:100%;" data-fragment-index="0"><code>$ docker run -it --name myalpine alpine /bin/sh</code></pre>
                    
                    <pre class="fragment" style="width:100%;" data-fragment-index="1"><code>❯ docker ps
CONTAINER ID        IMAGE                                ...   NAMES
db1faf244e7a        alpine                               ...   myalpine
02aa3e50580c        heytrav/docker-introduction-slides   ...   docker-intro</code></pre>
                    <ul style="width:80%;">
                        <li class="fragment" data-fragment-index="2">Exit the shell</li>
                        <li class="fragment" data-fragment-index="2">Repeat
                            using same name.
                            What happens?</li>
                    </ul>
<asciinema-player  class="fragment" data-fragment-index="3" autoplay="1" loop="loop"  font-size="medium" speed="1"
    theme="solarized-light" src="lib/name-in-use-error.json" cols="200"
    rows="6"></asciinema-player>
                    
                    
                  </section>
                  <section>
                    <h3>Removing containers</h3>
                    <p class="fragment" data-fragment-index="0">
                    <code>docker</code> <code style="color:red;">rm</code> <code style="color:green;">name|containerID</code>
                    </p>
                  </section>

                  <section>
                    <h4>Exercise: remove old <code>myalpine</code> container</h4>
                    <pre class="fragment" data-fragment-index="0"><code>$ docker rm myalpine</code></pre>
<asciinema-player  class="fragment" data-fragment-index="0" autoplay="1" loop="loop"  font-size="medium" speed="1"
    theme="solarized-light" src="lib/remove-container.json" cols="200" rows="12"></asciinema-player>
<p class="fragment" data-fragment-index="1">
If you pass the <code style="color:red;">--rm</code> flag to <code>docker run</code>, containers will be cleaned up when
stopped.
</p>
                  </section>
                  <section>
                    
                    <h4>
                      Exercise: Run website in a container
                    </h4>
                    <pre><code>$ docker run [OPTIONS] dockersamples/static-site</code></pre>
                    <ul>
                      <li class="fragment" data-fragment-index="0">Find
                          values for [OPTIONS]:
                          <ul>
                              <li>Give it the name: <em>static-site</em></li>
                              <li>Pass <code>AUTHOR="YOURNAME"</code> as environment variable</li>
                              <li>Map port 8081 to 80 internally (hint <code>8081:80</code>)</li>
                              <li>
                                  Cleans up container on exit
                              </li>
                          </ul>
                      </li>
                    </ul>
<asciinema-player autoplay="1" class="fragment" data-fragment-index="1" loop="loop"  font-size="medium" speed="1"
    theme="solarized-light" src="lib/static-site-v1.json" cols="120" rows="8"></asciinema-player>
<ul class="fragment" data-fragment-index="2" >
    <li>
        Note: <code>docker run</code> implicitly pulls image if not available
    </li>
<li>Try to exit using CTRL-C. What happens?</li>
</ul>
                  </section>

                  <section>
                    <h3>Stop a running container</h3>
                    <p>
                    <code>docker</code> <code style="color:red;">stop</code>
                    <code style="color:green;">name|containerID</code>
                    </p>
                    
                  </section>
                  <section>
                    <h4>Exercise: Stop the <code>static-site</code> container</h4>

                    <ul>
                      <li class="fragment" data-fragment-index="0">
                        You actually have a couple options:
                        <ul>
                          <li class="fragment" data-fragment-index="1">use the name you gave to the container</li>
                          <li class="fragment" data-fragment-index="2">use the
                              <code>containerID</code> from <code>docker
                                  ps</code> output (will depend on your
                              environment)</li>
                        </ul>
                      </li>
                    </ul>
                    <pre class="fragment" data-fragment-index="1"><code>$ docker stop static-site</code></pre>
                    <pre class="fragment" data-fragment-index="2"><code>$ docker stop 25eff330a4e4</code></pre>

                  </section>
                  
                  
                  <section>
                    <h4>Exercise: Running a detached container</h4>
                    <ul>
                      <li>
                        Run static-site container like you did before, but add
                        option to run in the background (i.e.
                        <em>detached</em> state).
                      </li>
                    </ul>

                    <pre class="fragment" data-fragment-index="0"><code>$ docker run --rm --name static-site -e AUTHOR="YOUR NAME" \
    -d -p 8081:80 dockersamples/static-site</code></pre>
<asciinema-player  class="fragment" data-fragment-index="1" autoplay="1" loop="loop"  font-size="medium" speed="1"
    theme="solarized-light" src="lib/asciicast-122718.json" cols="120" rows="8"></asciinema-player>
                    
                    <aside class="notes">
                        <ul>
                            <li>Have users stop (<code>docker stop static-site</code>) and start this container with the exact same line</li>
                            <li>Have them run again with the <code>--rm</code> flag</li>
                        </ul>
                    </aside>

                  </section>

                  <section>
                      <h3>View container logs</h3>
                      <p>
                      <code>docker</code> <color
                      style="color:red;">logs</color> <code
                      style="color:blue;">[options]</code> <code
                  style="color:red;">CONTAINER</code>
                      </p>
<!--<script  data-autoplay="1" data-loop="1" data-size="small" data-speed="1" type="text/javascript" src="https://asciinema.org/a/122552.js" id="asciicast-122552" async></script>-->
 <table>
   <tr>
     <th>Option</th>
     <th>Argument</th>
     <th>Description</th>
   </tr>

   <tr><td><code>    --details    </code></td><td>       </td> <td>      Show extra details provided to logs</td></tr>
   <tr><td><code>-f, --follow     </code></td><td>       </td> <td>      Follow log output</td></tr>
   <tr><td><code>    --help       </code></td><td>       </td> <td>      Print usage</td></tr>
   <tr><td><code>    --since      </code></td><td> string</td> <td>            Show logs since timestamp (e.g. 2013-01-02T13:23:37) or relative (e.g. 42m for 42 minutes)</td></tr>
   <tr><td><code>    --tail       </code></td><td> string</td> <td>             Number of lines to show from the end of the logs (default "all")</td></tr>
   <tr><td><code>-t, --timestamps </code></td><td>       </td> <td>      Show timestamps</td></tr>
 </table>
                                         
<p>
See <a href="https://docs.docker.com/engine/reference/commandline/logs/">online documentation</a>
</p>
                  </section>
                  <section>
                    <h4>Exercise: view container logs for <code>static-site</code> container</h4>
 <asciinema-player class="fragment" data-fragment-index="0" autoplay="1" loop="1" font-size="medium" speed="1" theme="solarized-light" src="lib/asciicast-122552.json" cols="170" rows="14"></asciinema-player>
                    <p class="fragment" data-fragment-index="1">Note: Go to <a href="http://localhost:8081">localhost:8081</a> and refresh a few times</p>
                  </section>
                  <section>
                    <h3><code>docker exec</code></h3>
                   
                    <p style="width:100%">
                    <code>docker</code> <code style="color:red;">exec </code>
                    <code style="color:purple;">[options] </code> <code
                    style="color:red;">CONTAINERID</code> <code style="color:blue;">[command]</code>
                    </p>
                    <ul style="width:80%">
                      <li>A way to interact with a running container</li>
                      <li>Open a shell inside a running container.</li>
                      <li> A bit like ssh'ing into a machine</li>
    <li>Can be useful for debugging</li>
                    <li>
                      See <a href="https://docs.docker.com/engine/reference/commandline/exec/">online documentation</a>
                    </li>                   
                    </ul>
                  </section>
                  <section>
                    <h4>
                      Exercise: Check process list in <code>static-site</code> container
                    </h4>


<asciinema-player class="fragment" data-fragment-index="0"  autoplay="1" loop="1" font-size="medium"
   theme="solarized-light" speed="1" src="lib/asciicast-122554.json" cols="150" rows="13"></asciinema-player>

                  </section>
                  <section>
                    <h3>List local images</h3>
                    <pre><code>$ docker image ls</code></pre>
<asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1"
    theme="solarized-light" src="lib/asciicast-119494.json" cols="174" rows="7"></asciinema-player>
                  </section>


                    <section>
                      <h3>Behind the scenes</h3>
                      <ul>
                        <li>User types docker commands</li>
                        <li>Docker client contacts docker daemon</li>
                        <li>Docker daemon checks if image exists</li>
                        <li>Docker daemon downloads image from docker registry
                        if it does not exist</li>
                        <li>Docker daemon runs container using image</li>
                      </ul>
                    </section>
                  <section>
                    <h3>Docker architecture</h3>

                    <img src="img/architecture.svg" alt="Architecture">
                    <aside class="notes">
                      <ul>
                        <li>Expalin architecture diagram (Commands and components).</li>
                        <li>Client vs daemon.</li>
                        <li>Union file systems; each command in a Dockerfile creates a new layer in an image.</li>
                        <li>Docker's use of UFS separates it from other container solutions.</li>
                        <li>Execute the "docker run" command and go through the list of steps it does.
                          <ul>
                            <li>Use sudo, unless you are in the Docker group (because of kernel feature permissions)</li>
                            <li>-i for interactive mode, -t for pseudo-tty allocation (Both let you use bash like a terminal)</li>
                          </ul></li>
                          <li>Namespaces => isolation of filesystem and kernel features.</li>
                          <li>Control groups => resource limiting.</li>
                          <li>Different container format avaialble, default is libcontainer</li>
                      </ul></aside>
                    <aside class="notes">
                        <ul>
                            <li>Docker client talks to Docker Daemon</li>
                            <li>Docker Daemon does heavy lifting</li>
                            <li>
                                Client and daemon 
                                <ul>
                                    <li>can run on the same system</li>
                                    <li>communicate using REST API</li>
                                </ul>
                            </li>
                        </ul>
                    </aside>
                    
                  </section>


                </section>



                <section>
                  <section>
                    <h2>How Docker works</h2>
                  </section>

                    <section>
                        <h3>Components of Docker</h3>
                        <ul>
                            <li>Images
                                <ul>
                                    <li>The build component</li>
                                    <li>Distributable <em>artefact</em></li>
                                </ul>
                            </li>
                            <li>Containers
                                <ul>
                                    <li>The run component</li>
                                </ul>
                            </li>
                                
                            <li>Registries
                                <ul>
                                    <li>The distribution component</li>
                                </ul>
                            </li>
                        </ul>
                        <aside class="notes">Remember: Images are like templates/classes, containers are like instances/objects.</aside>
                    </section>
                    <section class="image-slide">
                        <h3>Components of Docker</h3>
                        <img
                        src="http://alandargan.com/wp-content/uploads/2014/11/Docker2.png" alt="">
                        <aside class="notes"><ul>
                                <li>Images
                                    <ul>
                                        <li>The build component</li>
                                        <li>Distributable <em>artefact</em></li>
                                    </ul>
                                </li>
                                <li>Containers
                                    <ul>
                                        <li>The run component</li>
                                    </ul>
                                </li>

                                <li>Registries
                                    <ul>
                                        <li>The distribution component</li>
                                    </ul>
                                </li>
                            </ul></aside>
                    </section>



                  <section>
                    <h3>Docker Registries</h3>
                    <div style="float:left;width:50%">
                      <ul>
                        <li>Public repositories for docker images
                          <ul>
                            <li><a href="https://hub.docker.com">Docker Hub</a></li>
                            <li><a href="https://quay.io">Quay.io</a></li>
                            <li>GitLab ships with docker registry</li>
                          </ul>
                        </li>
                        <li>
                          Create your own private registry
                          <a href="https://github.com/docker/distribution">docker/distribution</a>
                        </li>
                      </ul>
                    </div>
                    <div style="float:left;width:50%">
                      <img src="img/docker-hub.png" />
                    </div>
                  </section>
                    <section>
                        <h3>
                            Underlying technology
                        </h3>
                        <dl>
                            <dt>Go</dt><dd>Implementation language developed by Google</dd>
                            <dt>Namespaces</dt><dd>Provide isolated workspace, or <em>container</em></dd>
                            <dt>cgroups</dt><dd>limit application to specific set of resources </dd>
                            <dt>UnionFS</dt><dd>building blocks for containers </dd>
                            <dt>Container format</dt><dd> Combined namespaces,
                            cgroups and UnionFS</dd>
                        </dl>

                        <aside class="notes"><dl>
                               <dt>Namespace</dt> <dd>
                                    provides layer of isolation. Each container
                                    runs in isolated namepsace and only has access to
                                    components in that namespace
                                </dd>
                                <dt>cgroup</dt> 
                                <dd>
                                allow Docker Engine to share available
                                hardware resources to containers and
                                optionally enforce limits and constraints. For
                                example, you can limit the memory available to
                                a specific container.
                                </dd>
                                <dt>Union Filesystem</dt>
                                <dd>
                                operate by creating layers, making them very
                                lightweight and fast. currently supports AUFS,
                                btrfs, vfs, device mapper
                                </dd>
                                <dt>Container format</dt>
                                <dd>
                                libcontainer is default. In the future will
                                integrate with Solaris Zones, BSD Jails
                                </dd>

                            </dl></aside>
                    </section>

                <!-- Large image slide -->


                </section>

                

                <section>
                  <section>
                    <h2>Images and Containers</h2>

                    <aside class="notes">
                        Understanding how Docker manages the data within your images and containers will help you understand the best way to design your containers and Dockerize your applications, and avoid performance problems along the way
                    </aside>
                  </section>

                  <section>
                    <h3>Docker images</h3>
                    <ul>
                      <li>Images are the basis of containers</li>
                      <li>An image is a <em>readonly</em> file system similar to tar archive</li>
                      <li><em>Distributable</em> artefact of Docker</li>
                    </ul>
                  </section>
                  <section>
                    <h3>Types of images</h3>
                    <dl>
                      <dt>Official Base Image</dt> 
                      <dd>Created by single authority (OS, packages):
                      <br>
                              <ul style="width:50%;">
                                  <li>ubuntu:16.04</li>
                                  <li>
                                      centos:7.3.1611
                                  </li>
                                  <li>
                                      postgres
                                  </li>

                              </ul>
                      </dd>
                      <dt>Base Image</dt> <dd>Can be any image (official or otherwise) that is used to build a new image</dd>
                      <dt>Child Images</dt> <dd>Build on base images and add functionality (this is the type you'll build)</dd>
                    </dl>

                  </section>
                  <section>
                      <h3>Layering of images</h3>
                      <ul >
                          <li>Images are <em>layered</em></li>
                          
                          <li>Any child image built by adding layers on top of base</li>
                          <li>Each successive layer is set of differences to preceding layer</li>
<li>
                              A layer is an instruction that 
                              <ul>
                                  <li>change filesystem</li>
                                  <li>tells Docker what to do when run</li>
                              </ul>

                          </li>
                      </ul>
                      <table class="fragment" data-fragment-index="0" >
                          <tr>
                              <th>Layer      </th>
                              <th>Description</th>
                          </tr>
                          <tr><td>4 </td>         <td>execute <code>myfile.sh</code></td></tr>
                          <tr><td>3 </td>         <td>make myfile.sh executable</td></tr>
                          <tr><td>2 </td>         <td>copy myfile.sh to working directory</td></tr>
                          <tr><td>1 </td>         <td>install libs</td></tr>
                          <tr><td>0 </td>         <td>Base Ubuntu OS</td></tr>
                      </table>
                  </section>
                  <section>
                      <h3>Image layers</h3>
                      <img src="img/container-layers.jpg"/>
                  </section>
                  <section>
                      <h3>Sharing image layers</h3>
                      <ul>
                          <li>Images will share any common layers</li>
                          <li>
                              Applies to 
                              <ul>
                                  <li>Images pulled from Docker </li>
                                  <li>Images you build yourself</li>
                              </ul>
                          </li>
                      </ul>
                  </section>
                  <section>
                      <h3>
                          Container basics
                      </h3>
                  </section>
                    <section>
                        <h3>Namespaces</h3>

                        <div style="float:left;width:50%">
                            <ul>
                                <li>Restrict visibility</li>
                                <li>Processes inside a namespace should only see that namespace</li>
                                <li>
                                    Namespaces:
                                    <ul>
                                        <li>pid</li>
                                        <li>mnt</li>
                                        <li>user</li>
                                        <li>ipc</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                        <div style="float:right;width:50%">
                            <img src="img/docker-namespaces.png"
                                 alt="Namespaces"/>
                        </div>

                    </section>
                    <section>
                        <h3>Cgroups</h3>

                        <div style="float:left;width:50%">
                            <ul>
                                <li>Restrict usage</li>
                                <li>Highly flexible; fine tuned</li>
                                <li>
                                    Cgroups:
                                    <ul>
                                        <li>cpu</li>
                                        <li>memory</li>
                                        <li>devices</li>
                                        <li>pids</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                        <div style="float:right;width:50%">
                            <img src="img/cgroups.svg"
                                 alt="cgroups"/>
                        </div>

                    </section>

                    <section>
                        <h3>Combining the two</h3>
                        <p>
                        A running container represents a combination of
                        layered file system,
                        namespace and sets of cgroups
                        </p>
                        <img src="img/namespace-cgroup-combined.svg"
                             alt="Combined namespaces cgroups" />
                    </section>

                  <section>
                      <h3>Container layering</h3>
                      <ul>
                          <li>Container creates its own read/write layer on top of image</li>
                          <li>Multiple containers each have own read/write layer, but can share the actual image</li>
                      </ul>
                      <img src="img/sharing-layers.jpg"/>
                      <aside class="notes">
                          <ul>
                              <li>Difference between containers and images is top writable layer</li>
                              <li>All writes to container stored here</li>
                              <li>Lost when container deleted</li>
                          </ul>
                      </aside>

                  </section>
                  <section>
                      <h3>
                          Create images, explore layers
                      </h3>
                      <table style="width:100%;">
                          <tr>
                              <th>Docker command   </th>
                              <th>Description   </th>
                              <th>Syntax</th>
                          </tr>
                          <tr>
                              <td>  <code>diff</code> </td>
                              <td>  Inspect changes to files on a container's filesystem</td>
                              <td>  <code>docker </code><code >diff</code> <code style="color:purple">[options]</code> <code style="color:red;font-style:italic">CONTAINERID</code><code style="color:blue;font-style:italic"></code></td>
                          </tr>
                          <tr>
                              <td> <code>commit</code> </td>
                              <td>  Create a new image from a container's changes</td>
                              <td> <code>docker </code><code >commit</code> <code style="color:purple">[options]</code> <code style="color:red;font-style:italic">CONTAINER</code><code style="color:blue;font-style:italic"> [IMAGE[:TAG]]</code></td>
                          </tr>
                          <tr>
                              <td>  <code>history</code> </td>
                              <td>  Show history of an image</td>
                              <td>  <code>docker </code><code >history</code> <code style="color:purple">[options]</code> <code style="color:red;font-style:italic">image</code><code style="color:blue;font-style:italic">:tag</code></td>
                          </tr>
                      </table>
                  </section>

                  

<section>
                        <h4>Exercise: Explore image layers</h4>
                        <pre class="fragment" data-fragment-index="0"><code>$ docker run -it ubuntu:16.04 /bin/bash
root@CONTAINERID:/$ apt-get update 
root@CONTAINERID:/$ exit
$ docker ps -a
$ docker diff CONTAINERID</code></pre>
<pre class="fragment" data-fragment-index="1"><code>$ docker commit CONTAINERID ubuntu:update
13132d42da3cc40e8d8b4601a7e2f4dbf198e9d72e37e19ee1986c280ffcb97c</code></pre>
<pre class="fragment" data-fragment-index="2"><code>$ docker image ls
$ docker history ubuntu:16.04
$ docker history ubuntu:update</code></pre>
<ul class="fragment" data-fragment-index="3">
    <li>Created an image by committing changes in a container</li>
    <li>Now have two separate images</li>
    <li>Share common layers; only difference is new layer on ubuntu:update</li>
</ul>
                        
                        <aside class="notes">
                            <ul>
                                <li>If you'd like to keep changes made inside a container, it is possible to save them by committing the container.</li>
                                <li>Commiting creates a new image (ubuntu:update)</li>
                                <li>Now after the running container is stopped, it's possible to run again using ubuntu:update</li>
                            </ul>
                        </aside>

                    </section>
                </section>
                <section>

                    <section>
                        <h2>
                            Creating Docker Images
                        </h2>
                    </section>

                  <section>
                    <h3>Introducing the <em>Dockerfile</em></h3>
                      <ul>
                          <li>A text file</li> 
                          <li>Usually named <code>Dockerfile</code></li>
                          <li>Sequential instructions for building a Docker image</li>
                          <li>Each instruction creates a layer on the previous</li>
                      </ul>
                      
                      <aside class="notes">
                          Basically the Dockerfile is like a bash script. It
                          contains instructions for sequentially building an
                          image. Some instructions apply to running the image in a
                          container.
                      </aside>
                      
                  </section>
                  <section>
                    <h3>Structure of a Dockerfile</h3>
                    <ul>
                      <li>Start by telling Docker which base image to use
                          <pre><code class="Dockerfile">FROM &lt;base image&gt;</code></pre>
                      </li>
                      <li>A number of commands telling docker how to build image
                          <pre><code class="dockerfile">COPY . /app
RUN make /app</code></pre>
                      </li>
                      <li>Optionally tell Docker what command to run when the
                          container is started<pre><code
                                     class="dockerfile">CMD ["python", "/app/app.py"]</code></pre></li>
                          
                    </ul>
                  </section>
                  <section>
                    <h2>Common Dockerfile Instructions</h2>
                  </section>
                  <section>
                    <h4>FROM</h4>
                    <p>
                    <code>FROM </code><code style="color:red;">image</code><code style="color:blue;">:tag</code>
                    </p>
                    <p>Define the base image for a new image</p>
                    <pre><code>FROM ubuntu:17.04</code></pre>

                    <pre><code>FROM debian # :latest implicit</code></pre>

                    <pre><code>FROM my-custom-image:1.2.3</code></pre>
                    <ul style="width:80%;" >
                        <li>
                            Image can be
                            <ul>
                                <li>
                                    An official base image
                                    <ul>
                                        <li>ubuntu:16.04</li>
                                        <li>alpine</li>
                                        <li>postgres:9.4</li>
                                    </ul>
                                </li>
                                <li>
                                    Another image you have created
                                </li>
                            </ul>
                        </li>
                    </ul>

                  </section>
                  <section>

                    <h4>RUN</h4>
                    <p>
                    <code>RUN </code><code
                        style="color:red;">command</code><code style="color:blue;"> arg1 arg2 ...</code>
                    </p>
                    <p>Execute shell commands for building image</p>
                    <pre><code>RUN apt-get update && apt-get install python3</code></pre>
                    <pre><code>RUN mkdir -p /usr/local/myapp && cd /usr/local/myapp</code></pre>
                    <pre><code>RUN make all</code></pre>
                    <pre><code>RUN curl https://domain.com/somebig.tar | tar -xv | /bin/sh</code></pre>
                  </section>
                  <section>
                    <h4>COPY</h4>
                    <p>
                    <code>COPY </code><code style="color:red;">src dest</code>
                    </p>
                    <p>Copy files from build directory into image</p>
                    <pre><code>COPY package.json /usr/local/myapp</code></pre>
                    <pre><code>COPY . /usr/share/www</code></pre>
                  </section>

                  <section>
                    <h4>WORKDIR</h4>
                    <code>WORKDIR </code><code style="color:red;">path</code>
                    <ul style="width:100%;">
                      <li>Create a directory in the image</li>
                      <li>Container will run relative to this directory</li>
                    </ul>
                    <pre><code>WORKDIR /usr/local/myapp</code></pre>
                
                  </section>
                  <section>
                    <h4>CMD</h4>
                    <ul style="width:100%;">
                      <li>Provide defaults to executable</li>
                      <li>or provide executable</li>
                      <li>
                          Two ways to execute a command:
                          <ul>
                              <li >
                                  shell form: 
                                  <code>CMD </code><code style="color:red;">command</code><code style="color:blue;"> param1 param2 ...</code>
                              </li>
                              <li >
                                  exec form: <code>CMD ["command", "param1", "param2"]</code>
                              </li>

                          </ul>
                      </li>


                    </ul>
                  </section>
                  <section>
                      <h4>
                          Exercise: Write a basic Dockerfile
                      </h4>
                      <pre><code>$ cd ~/docker-introduction/sample-code/first-docker-file
                      </code></pre>
                      <ul style="width:80%;">
                          <li>
                            Write a <code>Dockerfile</code>:
                              <ul>
                                  <li>
                                      Named <code>Dockerfile</code>
                                  </li>
                                  <li>
                                      Based on alpine
                                  </li>
                                  <li>
                                      Set working directory to <code style="color:blue;">/app</code>
                                  </li>
                                  <li>Copy hello.sh into working directory</li>
                                  <li>make hello.sh executable</li>
                                  <li>tell docker to run hello.sh on docker run</li>
                              </ul>
                          </li>
                      </ul>
                      <pre class="fragment" data-fragment-index="0"><code>FROM alpine
WORKDIR /app
COPY hello.sh .
RUN chmod +x hello.sh
CMD ["./hello.sh"]</code></pre>
                      <p class="fragment" data-fragment-index="0">
                      Now that we have a Dockerfile, we can make an image
                      </p>

                            
                  </section>
                  <section>
                    <h3>
                      <code>docker build</code>
                    </h3>
                    <h4>Build Docker images</h4>
                    <p style="font-size:65%;">
                    <code>docker</code> <code style="color:red;">build</code>
                    <code style="color:purple">[options]</code> <code
                        style="color:red;">image</code><code style="color:blue;">:[tag]</code>
                    <code
                        style="color:red;">./path/to/Dockerfile</code>
                    </p>


                  <table>
                    <tr>
                      <th>Options</th>
                      <th>Arguments</th>
                      <th>Description</th>
                    </tr>

                    <tr>  <td><code>    --compress             </code></td><td>         </td>       <td>Compress the build context using gzip</td></tr>
                    <tr>  <td><code>-c, --cpu-shares           </code></td><td>  int    </td>         <td>CPU shares (relative weight)</td></tr>
                    <tr>  <td><code>    --cpuset-cpus          </code></td><td>  string </td>        <td>CPUs in which to allow execution (0-3, 0,1)</td></tr>
                    <tr>  <td><code>    --cpuset-mems          </code></td><td>  string </td>        <td>MEMs in which to allow execution (0-3, 0,1)</td></tr>
                    <tr>  <td><code>    --disable-content-trust</code></td><td>         </td>   <td>Skip image verification (default true)</td></tr>
                    <tr>  <td><code>-f, --file string          </code></td><td>         </td>   <td>Name of the Dockerfile (Default is 'PATH/Dockerfile')</td></tr>
                    <tr>  <td><code>    --pull                 </code></td><td>         </td>   <td>Always attempt to pull a newer version of the image</td></tr>
                    <tr>  <td><code>-t, --tag             </code></td><td>
                            list        </td>   <td>Name and optionally a tag in the 'name:tag' format</td></tr>
                  </table>
                  <p class="fragment" data-fragment-index="0">
                  Note that a path to folder with Dockerfile is always
                  required. When in same directory, use "."
                  </p>
                  </section>

                  
                  <section>
                      <h4>
                          Exercise: build image using Dockerfile
                      </h4>
                      <ul style="width:80%;">
                          <li>
                              Build a Docker image:
                              <ul>
                                  <li>Use Dockerfile from earlier example</li>
                                  <li>Name image YOURNAME/my-first-image</li>
                              </ul>
                          </li>
                      </ul>
                      <pre class="fragment" data-fragment-index="0"><code>$ docker build -t YOURNAME/my-first-image .
$ docker run YOURNAME/my-first-image</code></pre>
<asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1"
                                                               class="fragment"
                                                               data-fragment-index="0"
    theme="solarized-light" src="lib/docker-build.json" cols="174" rows="12"></asciinema-player>
                  </section>
<section>
                      <h3>
                          Image naming semantics
                      </h3>
                      <ul>
                          <li class="fragment" data-fragment-index="0">No
                              upper-case letters
                              </li>
                          <li class="fragment" data-fragment-index="1">
                              Tag is optional. Implicitly <em>:latest</em> if not specified
                              <ul>
                                  <li class="fragment" data-fragment-index="2"><code>postgres<em style="color:green">:9.4</em></code></li>
                                  <li class="fragment" data-fragment-index="3"><code>ubuntu == ubuntu<em style="color:green">:latest</em> == ubuntu:<em style="color:green">16.04</em></code></li>
                              </ul>
                          </li>
                          <li class="fragment" data-fragment-index="4">
                              If pushing to a registry, need url and username
                              <ul>
                                  <li class="fragment" data-fragment-index="5">
                                  If registry not specified, docker.io is default:
                                  <ul>
                                      <li>
                                          <code><em style="color:green">docker.io</em>/<em style="color:red">username</em>/my-image</code>
                                          ==
                                          <code><em style="color:red">username</em>/my-image</code>
                                      </li>
                                  </ul>
                                  </li>
                                  <li class="fragment" data-fragment-index="6"><code><em style="color:green">my.reg.com/</em>my-image:1.2.3</code></li>
                              </ul>
                          </li>



                      </ul>
                  </section>
                  <section>
                    <h3>More Dockerfile instructions </h3>
                    <dl>
                      <dt>EXPOSE        </dt>      <dd>ports to expose when running</dd>
                      <dt>VOLUME        </dt>      <dd>folders to expose when running</dd>
                    </dl>
                  </section>
                  
                  
                  <section>
                    <h4>ENTRYPOINT</h4>
                    <ul style="width:100%">
                        <li class='fragment' data-fragment-index="0">
                         Docker images need not be executable by default 
                        </li>
                      <li class='fragment' data-fragment-index="1">ENTRYPOINT
                          configures executable behaviour of container</li>
                      <li class="fragment" data-fragment-index="2">
                          <em>shell</em> and <em>exec</em> forms just like <code>CMD</code>
                      </li>

                    </ul>
                    <pre class="fragment" data-fragment-index="3"><code>$ cd ~/docker-introduction/sample-code/entrypoint_cmd_examples
$ docker build -t not-executable -f Dockerfile.notexecutable .
$ docker run not-executable # does nothing</code></pre>
                    <pre class="fragment" data-fragment-index="4"><code>$ docker build -t executable -f Dockerfile.executable .
$ docker run executable</code></pre>
                    
                  </section>
                  <section>
                    <h4>Combining ENTRYPOINT &amp; CMD</h4>
                    <ul>
                      <li class="fragment" data-fragment-index="0">Arguments following the image for <code>docker run image</code> overrides <code>CMD</code></li>
                        <li class="fragment" data-fragment-index="1">
                            Use exec form of ENTRYPOINT and CMD together to set base
                            command and default arguments
                        </li>
                        <li class="fragment" data-fragment-index="2">Hypothetical application</li>
                    </ul>
                    <pre class="fragment" data-fragment-index="3"><code>FROM ubuntu:latest
.
.
ENTRYPOINT ["./base-script"]
CMD ["test"]</code></pre>
                    <pre class="fragment" data-fragment-index="4"><code>$ docker run my-image</code></pre>
                    <p class="fragment" data-fragment-index="5">
                    By default this image will just pass <code>test</code> as
                    argument to <code>base-script</code> to run unit tests by
                    default
                    </p>
                    <pre class="fragment" data-fragment-index="5"><code>$ docker run my-image server</code></pre>
                    <p class="fragment" data-fragment-index="6">
                    Passing argument at the end tells it to override CMD and
                    execute with <code>server</code> to run server feature
                    </p>
                  </section>





                  <!--<section>
                      <h4>Exercise: Build images with common layers</h4>
                      <p>
                      <code>~/docker-introduction/sample-code/layering</code>
                      </p>
                      <p>
                      <code>Dockerfile.base</code>


                      <pre><code class="dockerfile">FROM ubuntu:16.04
COPY . /app</code></pre>
                      </p>

                      <p>
                      <code>Dockerfile</code>


                      <pre><code class="dockerfile">FROM acme/my-base-image:1.0
CMD /app/hello.sh</code></pre>
                      </p>

                      <p>
                      <code>hello.sh</code>

                      <pre><code class="bash">#!/bin/sh
echo "Hello world"</code></pre>
                      </p>

                  </section>-->

                  <section>
                      <h4>
                          Exercise: build base image using Dockerfile
                      </h4>
                      <ul>
                          <li>Call image <code style="color:red;">acme/my-base-image</code></li>
                          <li>Tag it <code style="color:red;">1.0</code></li>
                      </ul>

                      <p>
                      <pre class="fragment" data-fragment-index="0"><code>$ cd ~/docker-introduction/sample-code/layering
$ docker build -t acme/my-base-image:1.0  .</code></pre>
                      </p>
<asciinema-player  class="fragment" data-fragment-index="0" autoplay="1"  font-size="medium" speed="3"
    theme="solarized-light" src="lib/build-base-image.json" loop="loop" cols="136" rows="18"></asciinema-player>
                  </section>
                  <section>
                      <h4>Exercise: Build child image from a base</h4>
                      <ul>
                          <li>Create <code style="color:red;">acme/my-final-image</code></li>
                          <li>Tag <code style="color:red">1.0</code></li>
                          <li>Use <code style="color:red">Dockerfile.child</code>
                              to build image</li>
                      </ul>
                      <pre class="fragment" data-fragment-index="0"><code>$ docker build -t acme/my-final-image:1.0 -f Dockerfile.child .</code></pre>
<asciinema-player  class="fragment" data-fragment-index="0" autoplay="1" loop="loop"  font-size="medium" speed="1"
    theme="solarized-light" src="lib/build-child-image.json" cols="136" rows="14"></asciinema-player>
                  </section>
                  <section>
                      <h4>Exercise: Compare base and child image layers</h4>
                      <ul>
                          <li>
                              Use: <code>docker</code> <code style="color:red;">history</code> <code style="color:green;">image</code>
                          </li>
                          <li>The final image should contain all the same layers as the base image </li>
                          <li>One additional layer: the last line of the Dockerfile</li>
                      </ul>
                      <pre><code>$ docker history acme/my-base-image:1.0
$ docker history acme/my-final-image:1.0
IMAGE         ...                                        SIZE 
5932655b26aa  ...   #(nop)  CMD ["/bin/sh" "-c" "/a...   0 B&lt;--new layer
2f723f94263a  ...   #(nop) COPY dir:dd75f285798cdc9...   106 B
8d4c9ae219d0  ...   #(nop)  CMD ["/bin/bash"]            0 B
&lt;missing&gt;     ...   mkdir -p /run/systemd && echo '...   7 B
&lt;missing&gt;     ...   sed -i 's/^#\s*\(deb.*universe\...   2.78 kB
&lt;missing&gt;     ...   rm -rf /var/lib/apt/lists/*          0 B
&lt;missing&gt;     ...   set -xe   && echo '#!/bin/sh' >...   745 B
&lt;missing&gt;     ...   #(nop) ADD file:9e2eabb7b05f940...   106 MB
                      </code></pre>
                  </section>


                  <!--<section>
                    <h3>Images and Tags</h3>
                    <ul>
                      <li>Tags specify a particular version of an image<pre><code>$ docker pull ubuntu:14.04</code></pre></li>
                      <li>Default to <em>latest</em>. In most cases this is a LTS version<pre><code>$ docker pull ubuntu</code></pre></li>
                        <li>Registries like Docker Hub contain >> 100K images<pre><code>$ docker search ubuntu</code></pre></li>

                    </ul>
                  </section>-->
                  


                </section>
                <section>
                    <section>
                        <h2>Dockerising applications</h2>
                    </section>
                  <section>
                    <h3>Create web application in Docker </h3>
                    <ul>
                      <li>Create a small web app based on Python Flask</li>
                      <li>Write a Dockerfile</li>
                      <li>Build an image</li>
                      <li>Run the image</li>
                      <li>Upload image to a Docker registry</li>
                    </ul>
                  </section>
                  <section>
                    <h3>Step 1. Set up the web app</h3>
                    <ul>
                      <li>Under <code>~/docker-introduction/sample-code/flask-app</code>
                        <dl>
                          <dt>app.py</dt> <dd>A simple flask application for displaying cat pictures</dd>
                          <dt>requirements.txt</dt> <dd>list of dependencies for flask</dd>
                          <dt>templates/index.html</dt> <dd>A jinja2 template</dd>
                          <dt>Dockerfile</dt><dd>Instructions for building a Docker image</dd>
                        </dl>
                      </li>
                    </ul>

                  </section>



                  <section>
                      <h3>Our Dockerfile</h3>
                    <pre><code>FROM alpine:3.5

# Install python and pip
RUN apk add --update py2-pip

# install Python modules needed by the Python app
COPY requirements.txt /usr/src/app/
RUN pip install --no-cache-dir -r /usr/src/app/requirements.txt

# copy files required for the app to run
COPY app.py /usr/src/app/
COPY templates/index.html /usr/src/app/templates/

# tell the port number the container should expose
EXPOSE 5000

CMD ["python", "/usr/src/app/app.py"]</code></pre>
                  </section>

                  <section>
                    <h3>
                      Build the Docker image
                    </h3>
                    <pre><code>$ cd ~/docker-introduction/sample-code/flask-app 
$ docker build -t YOURNAME/myfirstapp .</code></pre>
<asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1" theme="solarized-light" src="lib/asciicast-119506.json" cols="174" rows="22"></asciinema-player>
<p>
Note: please replace YOURNAME with your Docker Hub username
</p>
                  </section>

                  <section>
                    <h3>
                      Run the container
                    </h3>
                    <pre><code>$ docker run -p 8888:5000 --rm --name myfirstapp YOURNAME/myfirstapp</code></pre>
<asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1" theme="solarized-light" src="lib/asciicast-119510.json" cols="174" rows="11"></asciinema-player>
                    ...Now open <a href="http://localhost:8888">your test webapp</a>
                  </section>


                  <section>
                      <h3>Login to a registry</h3>

                      <pre><code>$ docker login &lt;registry url&gt;</code></pre>
<asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1" theme="solarized-light" src="lib/asciicast-120558.json" cols="138" rows="11"></asciinema-player>
<ul>

  <li>If registry not specified, logs into <a href="https://hub.docker.com">hub.docker.com</a></li>
  <li>Can log in to multiple registries</li>

</ul>
                  </section>

                  <section>
                    <h3>
                      Push image to registry
                    </h3>
                    <pre><code>$ docker push YOURNAME/myfirstapp</code></pre>

<asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1" theme="solarized-light" src="lib/asciicast-119547.json" cols="174" rows="12"></asciinema-player>
                  </section>




                  <section>
                    <h3>Summary</h3>
                    <ul>
                      <li>Wrote a small web application</li>
                      <li>Used Dockerfile to create an image</li>
                      <li>Pushed image to upstream registry</li>
                    </ul>
                    <aside class="notes">
                      <ul>
                        <li>Docker allowed us to create and test an app on an arbitrary OS without physical hardware</li>
                        <li>Create an artefact which we can share with coworkers, test and deploy</li>
                      </ul>
                    </aside>
                  </section>


                  <!-- Large image slide -->
                </section>
                <section>
                    <section>
                        <h2>Dockerfile best practices</h2>
                    </section>

                    <section>
                        <h3>General guidelines</h3>
                        <ul>
                            <li>Containers should be as ephemeral as possible</li>
                            <li>Avoid installing unnecessary packages</li>
                            <li>Minimise concerns <ul><li>Avoid multiple processes/apps in one container</li></ul></li>
                        </ul>

                        <aside class="notes">
                            <ul><li>
                                    By ephemeral is meant that a container can be built, stopped, destroyed and rebuilt with minimal setup and configuration
                                </li>
                                <li>dockerignore to avoid copying in unneeded stuff (.git subdirectory)</li>
                            </ul>
                        </aside>
                    </section>
                    <section>
                        <h3>
                            Use a <code>.dockerignore</code> file
                        </h3>
                        <pre><code># .dockerignore
.git*
.dockerignore
Dockerfile
README*
# don't import python virtualenv
.venv</code></pre>
                        <ul>
                            <li>Top level of your project</li>
                            <li>Very similar to <code>.gitignore</code></li>
                            <li>
                                <code>COPY . dest/</code> will not copy files
                                ignored in <code>.dockerignore</code>
                            </li>
                            <li>
Include things you don't want in your image:
                                <ul>
                                    <li>
                                        <code>.git</code> directory
                                    </li>
                                    <li>
                                        <code>node_modules</code>, <code>virtualenv</code> directories
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h3>General guidelines</h3>
                        <ul>
                            <li>Use current official repositories in FROM as base image
								
                            </li>
                            <li>
                                Image size may be a factor on cloud hosts where
                                space is limited
                                <ul>
									<li>debian 124 MB</li>
									<li>ubuntu 117 MB</li>
									<li>alpine 3.99 MB</li>
									<li>busybox 1.11 MB</li>
								</ul>
                            </li>
                            <li>
                                Choice of image depends on other factors
                            </li>
                            
                        </ul>

                    </section>
                    
                    
                    

                    <section>
                        <h3>
                            Package management and layers
                        </h3>

                        <div style="width:50%;float:left">
                        <p>Image size: 471 MB</p>
                            <pre style="font-size:10pt;"><code>FROM ubuntu:latest

RUN apt-get update \ 
 && apt-get install -y \
    libsqlite3-dev \
    mercurial \
    automake \
    build-essential \
    curl \
    dpkg-sig \
    aufs-tools \
    libcap-dev \
    reprepro</code></pre>
                        </div>
                        

                        <div style="float:left;width:50%">
                            <p>Image size: 430 MB</p>
                            <pre style="font-size:10pt;"><code>FROM ubuntu:latest

RUN apt-get update \
  && apt-get install -y \
    aufs-tools \
    automake \
    build-essential \
    curl \
    dpkg-sig \
    libcap-dev \
    libsqlite3-dev \
    mercurial \
    reprepro \
&& rm -rf /var/lib/apt/lists/*</code></pre>
                        </div>
                        <ul>
                            <li>Sort multiline arguments</li>
                            <li>Split complex RUN statement on separate lines with backslashes</li>
                            <li>Run apt-get update and apt-get install in same RUN </li>
                            <li>Run clean up in same line whenever possible</li>
                        </ul>
                    </section>
                    <section>
                      <h3>Layer caching</h3>
                      <pre><code>$ cd ~/docker-introduction/sample-code/caching
$ docker build -t caching-example -f Dockerfile.layering . </code></pre>
                      <ul>
                        <li class="fragment" data-fragment-index="0">Build image in <code>sample-code/caching</code> directory</li>
                        <li class="fragment" data-fragment-index="1">Run build a second time. What happens?</li>
<li class="fragment" data-fragment-index="2" >Change line with Change me! and run again</li>
                        <li class="fragment" data-fragment-index="3">Each instruction creates a layer in an image</li>
                        <li class="fragment" data-fragment-index="4">Docker caches layers when building</li>
                        <li class="fragment" data-fragment-index="5">When a layer is changed Docker rebuilds from changed layer</li>
                      </ul>

                      
                    </section>
                    
                    <section>
                        <h3>Consequences of layer caching</h3>
                        <div style="width:100%">
                            <div style="float:left;width:50%">
                                <pre><code class="dockerfile"># Example 1
FROM ubuntu:latest
RUN apt-get update
RUN apt-get install -y curl
#RUN apt-get install -y nginx</code></pre>

                            </div>
                            <div style="float:left;width:50%">
                                <pre><code class="dockerfile"># Example 2
FROM ubuntu:latest
RUN apt-get update \
  && apt-get install -y curl #nginx</code></pre>
                            </div>
                        </div>
                        <div style="width:100%;float:left" class="fragment"
                            data-fragment-index="0" >
                            <pre><code>$ cd ~/docker-introduction/sample-code/caching
$ docker build  -t bad-apt-example -f Dockerfile.bad .
$ docker build  -t good-apt-example -f Dockerfile.good .
                            </code></pre>
                        </div>
                        <ul>
                            <li class="fragment"
                                data-fragment-index="1">Uncomment nginx line
                                and run <code>docker build</code> again</li>
                            <li class="fragment" data-fragment-index="2">Only rebuilds from layer that was <em>changed</em></li>
                            <li class="fragment"
                                data-fragment-index="3">Example 1: <code>apt-get update</code> does not refresh index
                                <ul>
                                    <li>apt repos might change</li>
                                </ul>
                                <li class="fragment" data-fragment-index="4">
                                    Best to combine apt-get update and install
                                    packages to force apt to refresh index
                                    (Example 2)
                                </li>
                            </li>
                        </ul>
                        
                    </section>

                    
                    <section>
                        <h3>ADD is BADD</h3>
                        <ul style="width:80%">
                            <li class="fragment" data-fragment-index="0">Copies files to a directory
                                <pre><code>ADD . /usr/path/</code></pre>
                            </li>
                            <li class="fragment" data-fragment-index="1">Downloads file from web <pre><code>ADD http://domain.com/file.txt /usr/path/</code></pre></li>
                            <li class="fragment"
                                data-fragment-index="2">Unpack archives into
                                directory<pre><code>ADD file.tar /usr/path/ </code></pre></li>
                            <li class="fragment"
                                data-fragment-index="3">However, does not
                                unpack remote archives. This will just put
                                <code>file.tar</code> in
                                <code>/usr/path/</code><pre><code>ADD http://domain.com/file.tar /usr/path/ </code></pre></li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>Problems with ADD</h3>
                        
                        <ul style="width:100%">
                            <li class="fragment" data-fragment-index="0">Large
                                intermediate layers
                                
                                <pre><code>ADD http://domain.com/big.tar.gz /usr/path/ # large intermediate layer
RUN cd /usr/path && tar -xvf big.tar.gz \
   && rm big.tar.gz</code></pre> 
                                <ul><li>Increased overall image size</li></ul></li>
                            <li class="fragment" data-fragment-index="1">Better solution:
                                <pre><code>RUN curl -SL http://domain.com/big.tar.gz  \ 
   | tar -xJC /usr/path</code></pre>
                            <ul class="fragment" data-fragment-index="2"><li>Smaller image size</li></ul>
                            </li>
                            <li class="fragment" data-fragment-index="3">COPY only copies files <pre><code>COPY . /usr/path/</code></pre></li>
                            <li class="fragment" data-fragment-index="4">Recommend to only use COPY and never ADD</li>
                        </ul>
                    </section>
                    
                    <section>
                        <h3>
                            CMD &amp; ENTRYPOINT
                        </h3>
                        <h4>
                            General best practices
                        </h4>
                        <ul                             style="width:100;">
                            <li class="fragment" data-fragment-index="0"
>Avoid using <em>shell</em> form
                                <ul><li><code>ENTRYPOINT "executable param1 param2 ..."</code></li></ul></li>
                            <li class="fragment" data-fragment-index="1"
>
                                Docker directs POSIX commands at process with PID
                                1
                            </li>
                            <li class="fragment" data-fragment-index="2"
>
                                Using <em>shell</em> form, process is run internally using <code>/bin/sh
                                    -c</code> and do not have PID 1
                            </li>
                            <li class="fragment" data-fragment-index="3"
>
                                It can be difficult to stop container since
                                process does not receive SIGTERM from <code>docker stop container</code>
                            </li>
                            
                        </ul>
                        <pre class="fragment" data-fragment-index="4"><code>$ cd ~/docker-introduction/sample-code/entrypoint_cmd_examples
$ docker build -t runtop-shell -f Dockerfile.top_shell .
$ docker run --rm --name topshell runtop-shell</code></pre>
                        <p class="fragment" data-fragment-index="5">
                        What happens when you want to stop container
                        <em>topshell</em>?
                        </p>
                    </section>
                    <section>
                        <h3>
                            CMD &amp; ENTRYPOINT
                        </h3>
                        <h4>
                            General best practices
                        </h4>
                        <ul class="fragment" data-fragment-index="1"
                            style="width:100;">
                            <li>Best practice to use <strong>exec</strong> form: <ul><li><code>CMD ["executable", "param1", "param2", ..]</code></li></ul></li>
                            <li>Or in form that creates interactive shell like
                                <ul><li><code>ENTRYPOINT ["python"]</code></li><li><code>CMD ["/bin/bash"]</code></li></ul></li>
                        </ul>
                        <pre class="fragment" data-fragment-index="3"><code>$ docker build -t runtop -f Dockerfile.top .
$ docker run runtop</code></pre>
                    </section>
                    
<section>
                        <h3>
                            Image size and layers
                        </h3>
                        <h4>
                            Size of an image is the sum of layers
                        </h4>

                        <pre style="font-size:10pt" class="fragment"
                        data-fragment-index="0"><code>$ cd docker-introduction/sample-code/minimise
$ docker build -t nonminimal-container -f Dockerfile.nonmin .</code></pre>
<pre class="fragment" data-fragment-index="1" style="font-size:10pt"><code>$ docker history nonminimal-container

IMAGE               CREATED             CREATED BY                                      SIZE     
0b36a06204c2        About an hour ago   /bin/sh -c tar xf android-sdk_r24.4.1-linu...   678MB    
183874b1c90f        About an hour ago   /bin/sh -c #(nop) ADD cb7f541a55debac72db6...   326MB    
8cdbebaef087        About an hour ago   /bin/sh -c #(nop) WORKDIR /usr/local/app        0B       
eb62f9d5786a        About an hour ago   /bin/sh -c apk --no-cache add --virtual na...   150MB    
52bebd755930        10 hours ago        /bin/sh -c #(nop)  LABEL maintainer=develo...   0B       
e21c333399e0        10 days ago         /bin/sh -c #(nop)  CMD ["/bin/sh"]              0B       
&lt;missing&gt;           10 days ago         /bin/sh -c #(nop) ADD file:2b00f26f6004576...   4.14MB </code></pre>

                        <pre  class="fragment" data-fragment-index="2" style="font-size:10pt"><code>$ docker image ls
nonminimal-container ...    1.16GB</code></pre>

</section>
<section>
                        <h3>
                            Image size and layers
                        </h3>
    <h4>
        Reduce image size by compacting &amp; cleaning
    </h4>

                        <pre style="font-size:10pt"><code>$ docker build -t minimal-container -f Dockerfile.minimised .  </code></pre>
                        


<pre class="fragment" data-fragment-index="0" style="font-size:10pt"><code>$ docker history minimal-container
IMAGE               CREATED             CREATED BY                                      SIZE    
448e1f0f0bc9        3 hours ago         /bin/sh -c apk --no-cache add --virtual na...   679MB   
8df7061d2890        3 hours ago         /bin/sh -c #(nop) WORKDIR /usr/local/app        0B      
f897600e3104        3 hours ago         /bin/sh -c apk --no-cache add   g++    gcc...   150MB   
52bebd755930        11 hours ago        /bin/sh -c #(nop)  LABEL maintainer=develo...   0B      
e21c333399e0        10 days ago         /bin/sh -c #(nop)  CMD ["/bin/sh"]              0B      
&lt;missing&gt;          10 days ago         /bin/sh -c #(nop) ADD file:2b00f26f6004576...     4.14MB</code></pre>
                        <pre class="fragment" data-fragment-index="1" style="font-size:10pt"><code>$ docker image ls
minimal-container ...    833MB</code></pre>
<ul class="fragment" data-fragment-index="2" style="width:80%;">
                            <li>In contrast to the nonminimsed Dockerfile:</li>
                            <ul>
                                <li>Removed separate ADD layer</li>
                                <li>Temporily used wget to fetch tar</li>
                                <li>Unpack tar.gz</li>
                                <li>Remove wget in same layer</li>
                            </ul>
                            <li>
                                Drawback is Dockerfile becomes unreadable
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h3>
                            Multistage builds
                        </h3>
                        <h4>
                            Really really optimise image buiilds
                        </h4>
                        <pre style="font-size:10pt;"><code>############# Stage 1 ############
FROM ubuntu:16.04 as builder

RUN apt-get update && apt-get install -y \
     gcc \
     make \
     .
     .

WORKDIR /build
RUN wget http://source.com/bigbinary.tar.gz && tar -xzf bigbinary.tar.gz
RUN make all      # leaves compiled-binary in /build

############# Stage 2 ##############
FROM alpine:latest

WORKDIR /usr/local/app
COPY --from=builder /build/compiled-binary . </code></pre>
                        <ul>
                            <li>First section fetches libs and compiles binaries</li>
                            <li>
                                Greater freedom to choose <em>build image</em>
                            </li>
                            <li>Don't care about layers so much</li>
                            <li>Second build only copies compiled binary to smaller image</li>
                        </ul>
                    </section>
                    <section>
                        <h4>
                            Multistage builds example
                        </h4>
                        <pre style="font-size:10pt" class="fragment"
                                                    data-fragment-index="0"><code>$ docker build -t multistage -f Dockerfile.multistage .</code></pre>
                        <pre class="fragment" data-fragment-index="1" style="font-size:10pt"><code>$ docker history multistage

IMAGE               CREATED             CREATED BY                                      SIZE  
1f2cd3159a2d        2 hours ago         /bin/sh -c #(nop) COPY dir:50362890caeda88...   678MB 
fb2a20b96b65        2 hours ago         /bin/sh -c #(nop) WORKDIR /usr/local/app        0B    
e21c333399e0        10 days ago         /bin/sh -c #(nop)  CMD ["/bin/sh"]              0B    
&lt;missing&gt;           10 days ago         /bin/sh -c #(nop) ADD file:2b00f26f6004576...   4.14MB </code></pre>

                        <pre  class="fragment" data-fragment-index="2" style="font-size:10pt"><code>$ docker image ls
multistage ...    682MB</code></pre>

                    </section>
                    <!--<section>
                        <h3>ENTRYPOINT</h3>
                        <pre><code class="dockerfile">ENTRYPOINT ["python", "manage.py"]
CMD ["test"]</code></pre>
                        <ul>
                            <li>When used in conjunction with CMD:
                                <ul><li>Set base command with ENTRYPOINT</li>
                                    <li>Use CMD to set default argument</li> </ul></li> 
                            <li>Will just run tests when container is run with no params <ul><li><code>docker run myimage</code></li></ul></li>
                            <li>Can override by passing argument to container
                                <ul><li><code>docker run myimage runserver</code></li></ul></li>
                            <li>For more see <a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/">Dockerfile Best practices</a></li>
                        </ul>
                        <aside class="notes">
                            <ul>
                                <li>Use CMD when you want the user to have the choice of commands to run</li>
                                <li>Use ENTRYPOINT when you want to wrap a command</li>
                                <li>ENTRYPOINT can be overridden with the --entrypoint flag</li>
                            </ul>
                        </aside>
                    </section>-->

                </section>
                <section>
                  <section>
                    <h2>Docker and Development</h2>
                  </section>

                <section>
                    <h3>Microservices vs. Monoliths</h3>
                    <div style="float:left;width:50%">
                      <ul>
                        <li class="fragment" data-fragment-index="0">Small decoupled applications vs. one big app</li>
                        <li class="fragment" data-fragment-index="1">Developed independently</li>
                        <li class="fragment" data-fragment-index="2">Deployed and updated independently</li>
                        <li class="fragment" data-fragment-index="3">Scaled independently</li>
                        <li class="fragment" data-fragment-index="4">Better modularity</li>
                        <li class="fragment" data-fragment-index="5">Docker containers fit with microservice architecture</li>

                      </ul>
                    </div>
                    <div style="float:left;width:50%">
                      <img src="img/microservice-basic.png" />
                    </div>
                    <aside class="notes"><ul>
                        <li>
                          Compare to a monolith application which has grown with
                          time
                        </li>
                      <li><a href="http://martinfowler.com/articles/microservices.html">http://martinfowler.com/articles/microservices.html</a></li>
                    </ul></aside>
                </section>



                  <section>
                      <h3>Example voting application</h3>
                    <h4>Microservice application consisting of 5 components</h4>
                              <div style="width:50%;float:left">
                                <ul>

                                  <li class="fragment" data-fragment-index="0">Python web application</li>
                                  <li class="fragment" data-fragment-index="1">Redis queue</li>
                                  <li class="fragment" data-fragment-index="2">.NET worker</li>
                                  <li class="fragment" data-fragment-index="3">Postgres DB with a data volume</li>
                                  <li class="fragment" data-fragment-index="4">Node.js app to show votes in real time</li>
                                </ul>
                              </div>
                              <div style="float:left;width:50%">
                                <img src="img/voting-app.png" alt="Voting application"/>
                              </div>
                              <div style="float:left;width:100%;">
                                  <pre class="fragment" data-fragment-index="5"><code>$ git clone https://github.com/dockersamples/example-voting-app.git
$ cd example-voting-app</code></pre>
                              </div>
                  </section>

                  <section>
                    <h3>
                      Build vote app components
                    </h3>
                    <pre class="fragment" data-fragment-index="0"><code>$ docker build -t vote vote</code></pre>
                    <pre class="fragment" data-fragment-index="1"><code>$ docker build -t result result</code></pre>
                    <pre class="fragment" data-fragment-index="2"><code>$ docker build -t worker worker</code></pre>
                    <pre class="fragment" data-fragment-index="3"><code>$ docker image ls</code></pre>
                  </section>
                  
                  <section>
                      <h3>Run microservices</h3>

                      <!--<div style="width:20%;float:left;"><ul>
                              <li class="fragment" data-fragment-index="0">Run flask app 
                                  
                                  <ul>
                                      <li class="fragment" data-fragment-index="1">
                                          <code>--link</code> to connect redis and db to vote container
                                      </li>
                                  </ul>

                              </li>
                              <li class="fragment" data-fragment-index="2">
                                  Results app
                                  
                                  <ul>
                                      <li class="fragment" data-fragment-index="3"><code>-v</code> to mount directory as volume</li>
                                      <li class="fragment" data-fragment-index="4"><code>-p</code> to map ports in docker container</li>
                                  </ul>
                              </li>
                              <li class="fragment" data-fragment-index="5">
                                  Worker app
                              </li>

                          </ul></div>-->
                          <div >
                              <pre><code>#! /bin/bash
# Helper services
docker run --rm -d -p 6379:6379 --name redis redis:alpine
docker run --rm -d --name db postgres:9.4 

# Application
docker run --rm -d --name vote --link redis \
    --link db -v $PWD/vote:/app  -p 5000:80 vote

docker run --rm -d --name worker --link redis --link db worker

docker run --rm -d --name result -v $PWD/result:/app \
   --link db -p 5001:80 -p 5858:5858 result nodemon --debug server.js</code></pre>                  
                          </div>
                          <dl>
                              <dt><code>--link a:b</code></dt>   <dd>Link container <em>a</em> to container <em>b</em></dd>
                              <dt><code>-v  ./path:/var/lib/path</code></dt>   <dd>Mount a directory as a volume</dd>
                              <dt><code>-p  8080:80 </code></dt>   <dd>Map port in container</dd>
                          </dl>
                  </section>
                  <section>
                    <h3>Disadvantages of this approach</h3>
                    <ul>
                      <li>Complicated with shell/script commands
                          <ul>
                              <li>Managing service interactions</li>
                              <li>Adding/managing services</li>
                          </ul>
                      </li>
                      <li>Can't scale services</li>
                      <li>Stopping services is P.I.T.A.</li>
                      <li>Better tools exist..</li>
                    </ul>
                  </section>
                <section>
                    <h3>Docker Compose</h3>
                    <h4>Docker as a dev environment</h4>
                    <div style="width:50%;float:left;">
                        <ul>
                            <li class="fragment"
                                data-fragment-index="0">Declarative YAML syntax</li>
                          <li class="fragment" data-fragment-index="1">Specifies
                            <ul>
                              <li>Services</li>
                              <li>image or build</li> 
                              <li>volumes</li>
                              <li>environment variables</li>
                            </ul>
                          </li> 
                            <li class="fragment"
                                data-fragment-index="2">Interactive
                                development</li>
                            <li class="fragment" data-fragment-index="3">Can be used for staging/production environments</li>
                        </ul>
                    </div>
                    <div class="fragment" data-fragment-index="0" style="width:50%;float:left;">
                    <pre><code>---
# docker-compose.yml
version: '3'
services:
  web:
    build: .
    ports:
      - "5000:5000"
    volumes:
      - .:/code
      - logvolume01:/var/log
    links:
      - redis
  redis:
    image: redis
    volumes:
      logvolume01: {}</code></pre>
                    </div>
                </section>

                <section>
                    <h3>Docker Compose</h3>
                    <h4>Basic commands</h4>
                    <p>
                    <code>docker-compose</code> <code style="color:red;">COMMAND</code> <code style="color:blue;">[options]</code> <code>[args]</code>
                    </p>

                    <table>
                        <tr>
                            <th>Command</th>
                            <th>Description</th>
                        </tr>
                        <tr>
                            <td><code >up</code></td>
                            <td>Start compose</td>      
                        </tr>
                        <tr>
                            <td>
                                 <code >down</code>
                            </td>
                            <td>
                                Stop &amp; tear down containers/networks
                            </td>
                        </tr>
                        <tr>
                            <td>
                                 <code >restart</code> &lt;service name&gt;
                            </td>
                            <td>
                                Restart a service
                            </td>
                        </tr>
                        scale
                        
                    </table>
                    
                    <p class="fragment" data-fragment-index="0">Use
                    <code>docker-compose</code> <code
                    style="color:red;">-h</code> to view inline documentation</p>
                    <p class="fragment" data-fragment-index="1">Have a look at
                    the <a href="">documentation</a></p>

                </section>
                <section>
                    <h3>Docker Compose Example</h3>
                    <pre><code>$ cd example-voting-app
$ docker-compose up -d</code></pre>
<asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1"
    theme="solarized-light" src="lib/docker-compose.json" cols="174" rows="15"></asciinema-player>
<p class="fragment" data-fragment-index="0">
 <a href="http://localhost:5000">Vote</a> and <a href="http://localhost:5001">view results</a>
</p>
                </section>
                
                  <section>
                      <h3>Interactive development</h3>
                      <ul>
                          <li>Open up <code>vote/app.py</code> </li>
                          <li>On lines 8 & 9, modify vote options</li>
                          <li>View change in <a href="http://localhost:5000">voting</a> application</li>
                      </ul>
                  </section>
                  <section>
                      <h3>Change vote options</h3>
 <asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1" theme="solarized-light" src="lib/asciicast-120556.json" cols="138" rows="21"></asciinema-player>
                  </section>
                  <section>
                      <h3>Scaling services</h3>
                      <pre><code>$ docker-compose up -d --scale SERVICE=&lt;number&gt;</code></pre>
 <asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1"
     theme="solarized-light" src="lib/docker-compose-scaling-service.json" cols="138" rows="21"></asciinema-player>

                  </section>
                </section>  


                <section>
                  <section>
                    <h2>Container Orchestration</h2>
                  </section>

                <section>
                    <h3>First, some more buzzwords</h3>
                    <ul>
                        <li><a href="http://radar.oreilly.com/2015/06/an-introduction-to-immutable-infrastructure.html">Immutable infrastructure</a></li>
                        <li><a href="https://blog.engineyard.com/2014/pets-vs-cattle">Cattle vs pets</a></li>
                        <li><a href="http://martinfowler.com/bliki/SnowflakeServer.html">Snowflake Servers</a> vs. <a href="http://martinfowler.com/bliki/PhoenixServer.html">Phoenix Servers</a></li>
                    </ul>
                    <aside class="notes"><ul>
                      <li>Immutable architecture: Instead of mutating an instance, replace it with a new one.</li>
                      <li>Pets (nursed back to health) vs. Cattle (replaced when sick)</li>
                      <li>Snowflake (unique) vs. Phoenix (constantly rising from the ashes of its predecessor)</li>
                    </ul></aside>
                </section>

                <section>
                    <h3>Immutable Architecture/Infrastructure</h3>
                    <div style="float:left;width:50%"><ul>
                        <li>Phoenix servers</li>
                        <li>The environment is defined in code</li>
                        <li>If you need to change <em>anything</em> you create a new instance and destroy the old one</li>
                        <li>Docker makes it much more likely you will work in this way</li>
                      </ul></div>
                    <div style="float:left;width:50%"><img src="img/immutable_infrastructure.gif" alt="Immutable Architecture" ></div>
                    <aside class="notes">Docker basically forces you to not manually alter servers.</aside>
                </section>
                <!-- Large image slide -->
                
                  <section>
                    <h3>
                      Container orchestration 
                    </h3>
                    <ul>
                      <li>Frameworks for container orchestration
                        <ul>
                          <li>Docker Swarm</li>
                          <li>Kubernetes</li>
                        </ul>
                      </li>
                      <li>Manage deployment/restarting containers across clusters</li>
                      <li>Networking between containers (microservices)</li>
                      <li>Scaling microservices</li>
                      <li>Fault tolerance</li>
                      

                    </ul>
                  </section>
                <section>
                    <h3>Kubernetes</h3>
                    <ul>
                        <li>Container orchestrator</li>
                        <li>Started by Google</li>
                        <li>Inspired by Borg (Google's cluster management system)</li>
                        <li>Open source project written in Go</li>
                        <li>Cloud Native Computing Foundation</li>
                        <li>Manage applications not machines</li>
                    </ul>
                </section>
                <section>
                  <h3>Kubernetes Overview</h3>
                  <img src="img/kubernetes-diagram.png" alt="Kubernetes diagram">
                  <aside class="notes">The services and controllers actually run as processes on every node. The external load balancer is necessary to split traffic across the nodes, and once it reaches a node, the service will route it to the correct pod, or even a different node (see: http://www.dasblinkenlichten.com/kubernetes-101-external-access-into-the-cluster/).</aside>
                </section>
                <section>
                    <h3>Kubernetes Components</h3>
                    <ul>
                        <li>Pods - an ephemeral group of co-scheduled containers that together provide a service</li>
                        <li>Flat Networking Space - each pod has an IP and can talk to other pods, within a pod containers communicate via localhost (need to manage ports)</li>
                        <li>Labels - Key value pairs, used to label pods and other objects so the scheduler can operate on them</li>
                        <li>Services - stable endpoints comprised of one or more pods (external services are supported)</li>
                        <li>Replication Controllers - the orchestrator that controls and monitors the pods within a service (known as replicas)</li>
                    </ul>
                </section>
                <!--<section>
                    <h3>Pods/Services</h3>
                    <ul>
                        <li>Co-locate containers</li>
                        <li>Shared volumes</li>
                        <li>IP address (important for port space and migration)</li>
                        <li>Unit of deployment and migration</li>
                        <li>Easy migration = high utilisation</li>
                        <li>Scale service by scaling pods</li>
                    </ul>
                </section>-->
                  <section>
                      <h3>Docker Swarm</h3>
                      <div style="float:left;width:50%"><ul>
                          <li>Standard since Docker 1.12</li>
                          <li>Manage containers across multiple machines
                            <ul>
                              <li>Scaling services</li>
                              <li>Healthchecks</li>
                              <li>Load balancing</li>
                            </ul>
                          </li>
                        </ul></div>
                        <div style="float:left;width:50%">
                          <img src="img/dockerswarm.png" alt="Docker swarm"/>
                        </div>
                  </section>
                  <section>
                    <h3>Docker Swarm</h3>
                    <ul>
                      <li>Two types of machines or <em>nodes</em>
                        <ul>
                          <li>1 or more <em>manager</em> nodes</li>
                          <li>0 or more <em>worker</em> nodes</li>
                        </ul>
                      </li>
                      <li>Managers control global state of cluster</li>
                        <ul>
                          <li>Raft Consensus Algorithm</li>
                          <li>If one manager fails, any other should take over
                        </ul>
                      </li>
                      
                    </ul>
                  </section>
                  <section>

                    <img src="img/voting-app-swarm.png" alt="Docker swarm"/>
                  </section>
                  <section>
                      <h3>Swarm Stack File</h3>
                      <div style="float:left;width:50%"><ul>
                          <li>Similar to file used for <code>docker-compose</code></li>
                          <li>
                              A few differences
                              <ul>
                                  <li>No <code>build</code> option</li>
                                  <li>No shared volumes</li>
                              </ul>
                          </li>

                        </ul></div>
   <div style="float:left;width:50%;height:80%"><pre><code class="yaml"># stack.yml
version: "3.3" 
services:
  db:
    image: postgres:9.4
    .
    .
  redis:
    image: redis:latest
    deploy:
      replicas: 3

  vote:
    image: vote:latest
    depends_on:
      - redis
      - db
     deploy:
      replicas: 6
      update_config:
         delay: 5s
         parallelism: 1
    .
    .</code></pre></div>                  
                  </section>
                  
                  <section>
                      <h3>Initiate a Swarm</h3>
                      <pre><code>$ docker swarm init
$ cd ~/example-voting-app</code></pre>
                      <ul>
                          <li><code>docker swarm init</code> puts your machine in <em>swarm mode</em></li>
                          <li>Only need to do once to create manager node</li>
                      </ul>
                  </section>

                  <section>
                      <h3>Deploy the stack</h3>
                      <pre><code>$ docker stack deploy --compose-file docker-stack.yml vote</code></pre>
<asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1" theme="solarized-light" src="lib/asciicast-119595.json" cols="174" rows="15"></asciinema-player>
                  </section>

                  <section>
                      <h3>Verify stack is running</h3>
                      <pre style="width:100%"><code>$ watch docker stack ps vote</code></pre>
 <asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1" theme="solarized-light" src="lib/asciicast-119596.json" cols="174" rows="15"></asciinema-player>
Now, let's go <a href="http://localhost:5000">vote</a>! When you're done, have
a look at the <a href="http://localhost:5001">results</a>.
                  </section>

                  <section>
                      <h3>Build image</h3>
                      <p>
                      In example-voting-app...
                      </p>

                      <pre><code>$ docker build -t YOURNAME/vote:v2 vote</code></pre>
                      <p>Note: please replace <code>YOURNAME</code> with your docker hub
                      username if you have one</p>
<asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1"
    theme="solarized-light" src="lib/asciicast-120557.json" cols="138"
    rows="15"></asciinema-player>
                  </section>

                  

                    <section>
                        <h3>Update a service</h3>
                        <pre><code>$ docker service update --image YOURNAME/vote:v2 vote_vote</code></pre>
<p>
Now go to the <a href="http://localhost:5000">voting app</a> and see what
changed
</p>
                    </section>

                    <section>
                        <h3>Remove Swarm Stack</h3>
                        <pre><code>$ docker stack rm vote</code></pre>
<asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1"
    theme="solarized-light" src="lib/asciicast-120569.json" cols="130"
    rows="15"></asciinema-player>
                    </section>
                  <section>
                      <h3>Summary</h3>
                      <ul>
                          <li>Deployed a set of services on our local host</li>
                          <li>Docker created a couple networks (front-tier, back-tier)</li>
                          <li>Some services running multiple instances</li>
                          <li>Next, we'll look at doing this across multiple machines</li>
                      </ul>
                  </section>

                </section>

                <section>
                    <section>
                        <h2>Running apps in the cloud</h2>
                    </section>

                  <section>
                    <h3>Goals</h3>
                    <ul>
                      <li class="fragment" data-fragment-index="0">Set up cluster of multiple machines
                      <ul><li>Catalyst Cloud (OpenStack)</li></ul></li>
                      <li class="fragment" data-fragment-index="1">Install
                        Docker on each machine </li>
                      <li class="fragment" data-fragment-index="2">Initialise a swarm</li>
                      <li class="fragment" data-fragment-index="3">Deploy our voting app</li>
                       <li class="fragment" data-fragment-index="4">Run through a few typical scenarios
                           <ul>
                               <li>Rolling update with <em>vote:v2</em></li>
                               <li>Drain node for maintenance</li>
                           </ul>
                       </li> 
                    </ul>
                  </section>
                  <section>
                    <h3>Setting up cluster</h3>
                    <div style="float:left;width:50%">
                        <ul>
                            <li class="fragment" data-fragment-index="0">
                                Need to:
                                <ul>

                                  <li>provision machines</li>
                                    <li>set up router(s)</li>
                                    <li>set up security groups</li>
                                </ul>
                            </li>
                            <li class="fragment" data-fragment-index="1">
                                Preferable to use automation tools:
                                <ul>
                                    <li>Chef</li>
                                    <li>Puppet</li>
                                    <li>Terraform</li>
                                    <li>Ansible</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <div style="width:50%;float:left">
                        <img  class="fragment"
                        data-fragment-index="0"src="img/open-stack-swarm.png" />
                    </div>

                  </section>
                    <!--<section>
                        <h3>Ansible</h3>
                        <ul>
                            <li>Python based tool set</li>
                            <li>Automate devops tasks
                                <ul>
                                    <li>server/cluster management </li>
                                    <li>installing packages</li>
                                    <li>deploying code </li>
                                    <li>managing config</li>
                                </ul>
                        </ul>
                        </section>        -->
                    
                    <!--<section>
                        <h3>Setup steps</h3>
                        <pre class="fragment" data-fragment-index="0"><code>$ cd ~/catalystcloud-ansible
$ ./install-ansible.sh
.
.
$ source $CC_ANSIBLE_DIR/ansible-venv/bin/activate</code></pre>
                        <pre class="fragment" data-fragment-index="1"><code>$ source ~/os-training.catalyst.net.nz-openrc.sh</code></pre>
                        <ul class="fragment" data-fragment-index="2">
                            <li>Should have ansible installed</li>
                            <li>Should have activated and sourced a python virtualenv <ul><li><code>(ansible-env)</code> should appear at beginning of line in your shell</li></ul> </li>
                            <li>Sourced the environment file for the training account</li>
                        </ul>
                    </section>-->

                    <section>
                        <h3>Create a cluster</h3>
                        <ul>
                            <li>Login to <a
                                    href="https://dashboard.cloud.catalyst.net.nz">OpenStack
                                    Dashboard</a> with provided credentials</li>
                            <li>Navigte to API Acccess</li>
                            <li>Download OpenStack RC file</li>
                        </ul>
                        <pre><code>$ source os-training.catalyst.net.nz-openrc.sh
&lt;enter os training password&gt;

$ export OS_REGION_NAME=nz-hlz-1 
$ cd ~/catalystcloud-ansible/example-playbooks/docker-swarm-mode
$ ansible-playbook --ask-sudo-pass \
    --extra-vars "suffix=-$( hostname )" \
    create-swarm-hosts.yaml</code></pre>
                    </section>

                    <section>
                        <h3>Create Swarm</h3>

                         <pre><code>$ ssh manager&lt;TAB&gt;&lt;ENTER&gt;
$ docker swarm init</code></pre>
<asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1" theme="solarized-light" src="lib/asciicast-120530.json" cols="107" rows="12"></asciinema-player>

<p>
Copy the <code>docker swarm join ...</code> command that is output
</p>



                    </section>
                    <section>
                        <h3>Join Worker Nodes</h3>
                        <p>
                        Paste the command from the manager node onto command
                        line.
                        </p>

                        <pre><code>$ ssh worker1&lt;TAB&gt;&lt;ENTER&gt;
$ docker swarm join --token $TOKEN  192.168.99.100:2377</code></pre>
 <asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1" theme="solarized-light" src="lib/asciicast-120531.json" cols="107" rows="10"></asciinema-player>
<p>Repeat this for <code>worker2</code></p>
                    </section>

                    <section>
                        <h3>Check nodes</h3>
                        <pre><code>$ docker node ls</code></pre>
<asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1"
    theme="solarized-light" src="lib/asciicast-120532.json" cols="107" rows="6"></asciinema-player>
                    </section>

                    <section>
                        <h3>Deploying voting app</h3>
                        <p>
                        Upload docker-stack.yaml to manager node
                        </p>
                        <pre><code>$ cd ~/example-voting-app
$ scp docker-stack.yml manager1-TRAININGPC:~/</code></pre>
                    </section>
                    <section>
                        <h3>Deploy application</h3>
                        <pre><code>$ docker stack deploy -c docker-stack.yml vote</code></pre>
<script  data-autoplay="1" data-loop="1" data-size="small" data-speed="1" type="text/javascript" src="https://asciinema.org/a/120533.js" id="asciicast-120533" async></script>
                    </section>
                    <section>
                        <h3>Monitor deploy progress</h3>
                        <pre><code>$ watch docker stack ps vote</code></pre>
                        <pre><code>$ watch docker service ls</code></pre>
                    </section>
                    <section>
                        <h3>Try out the voting app</h3>
                        <dl>
                            <dt><a
                              href="http://voting.app:5000">http://voting.app:5000</a></dt>           
                            <dd>To vote</dd>
                            <dt><a
                              href="http://voting.app:5001">http://voting.app:5001</a></dt>
                            <dd>To see results</dd>
                            <dt><a
                              href="http://voting.app:8080">http://voting.app:8080</a></dt>
                            <dd>To visualise running containers</dd>
                        </dl>
                    </section>
                    <section>
                        <h3>Scale services</h3>
                        <pre><code>$ docker service scale vote_vote=3</code></pre>
                        <p>
                        Look at the changes in the <a href="http://voting.app:8080">visualizer</a>
                        </p>
                    </section>

                    <section>
                        <h3>Update a service</h3>
                        <pre><code>$ docker service update --image heytrav/vote vote_vote</code></pre>
<asciinema-player autoplay="1" loop="loop"  font-size="medium" speed="1"
    theme="solarized-light" src="lib/asciicast-120564.json" cols="146"
    rows="10"></asciinema-player>
<p>
Now go to the <a href="http://voting.app:5000">voting app</a> and verify the change
</p>
                    </section>
                    <section>
                        <h3>Developer workflow</h3>
                        <ul>
                            <li class="fragment" data-fragment-index="0">Push code to repository</li>
                            <li class="fragment" data-fragment-index="1">Continuous Integration (CI) system runs tests</li>
                            <li class="fragment" data-fragment-index="2">If tests successful, automate image build &amp; push to a docker registry</li>
                            <li class="fragment" data-fragment-index="3">Manually/automatically run <code>docker service update</code></li>
                            <li class="fragment"
                                data-fragment-index="4">Easy to setup with
                                existing services and automation tools like
                                Ansible
                                <ul>
                                    <li><a
                                        href="https://hub.docker.com">DockerHub</a>
                                    (eg. <a href="https://hub.docker.com/r/heytrav/docker-introduction-slides/builds/">these slides</a>)</li>
                                    <li><a href="https://github.com">GitHub</a></li>
                                    <li><a href="https://circleci.com">CircleCI</a></li>
                                    <li>GitLab</li>
                                    <li><a href="https://quay.io">Quay.io</a></li>
                                </ul>
                            </li>
                        </ul>
                    </section>
                
                    <section>
                        <h3>Drain a node</h3>
                        <pre><code>$ docker node update --availability drain worker1</code></pre>
                        <ul>
                            <li>
                                Sometimes necessary to take host offline
                                <ul>
                                    <li>Planned maintenance</li>
                                    <li>Patching vulnerabilities</li>
                                    <li>Resizing host</li>
                                </ul>
                            </li>

                            <li>Prevents node from receiving new tasks</li>
                            <li>Manager stops tasks running on node and launches replicas on active nodes</li>
                        </ul>
                        <aside class="notes">
                            This might be necessary if you need to do maintenance
                            on a particular host
                        </aside>
                    </section>
                    <section>
                        <h3>
                            Return node to service
                        </h3>
                        <pre><code>$ docker node update --availability active worker1</code></pre>
                        <ul>
                            <li>during a service update to scale up</li>
                            <li>during a rolling update</li>
                            <li>when you set another node to Drain availability</li>
                            <li>when a task fails on another active node</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Summary</h3>
                        <ul>
                            <li>
                                Created a cluster with a cloud provider using ansible
                                <ul>
                                    <li>1 manager node</li>
                                    <li>2 worker nodes</li>
                                </ul>
                            </li>
                            <li>Deployed microservice for voting app in Docker Swarm</li>
                            <li>Scaled service from 2 to 3 services</li>
                            <li>Rolling-Updated image</li>
                        </ul>


                    </section>
                    <section>
                        <h3>Tear down your cluster</h3>
                        <pre><code>$ ansible-playbook -K  --extra-vars "suffix=-$( hostname )" \ 
remove-swarm-hosts.yaml</code></pre>
                    </section>

                </section>

                
                


                <section>
                    <section>
                        <h2>Wrap up</h2>
                    </section>

                <section>
                    <h3>Docker ecosystem</h3>
                    <ul>
                        <li>An explosion of tools</li>
                        <li>Hard to keep up</li>
                        <li>Lets have a quick look</li>
                    </ul>
                </section>
                <!-- Large image slide -->
                <section class="image-slide">
                    <h2>Docker ecosystem</h2>
                    <img src="img/docker-ecosystem.png" alt="Docker Ecosystem" height="600" width="800">
                    <aside class="notes"><ul>
                      <li>Orchestration: Managing the lifecycle of containers (starting, stopping, etc.) and distributing them across hosts in a cluster.</li>
                      <li>Service Discovery: Manage directories of where services running in containers can find each other in a cluster of hosts.</li>
                      <li>Networking: Virtual networks across hosts in a cluster</li>
                      <li>Linux: Underlying Linux technologies that Docker uses.</li>
                    </ul></aside>
                </section>

                <section>
                    <h3>Competing technologies</h3>
                    <ul>
                        <li>rkt (CoreOS)</li>
                        <li>Serverless (FaaS) <ul>
                                <li>Lambda (AWS)</li> 
                                <li>Azure Functions (Microsoft)</li>
                                <li>Google cloud functions</li>
                                <li>iron.io</li>
                            </ul>
                        </li>
                    </ul>
                </section>
                
                </section>

                <section>
                    <section>
                        <h3>The end</h3>
                    </section>
                </section>


                


        </div>


        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>
        <script src="js/asciinema-player.js"></script>

        <script>

            // Full list of configuration options available here:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,

                theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
                transition: Reveal.getQueryHash().transition || 'none', // default/cube/page/concave/zoom/linear/fade/none

                // Parallax scrolling
                // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
                // parallaxBackgroundSize: '2100px 900px',

                // Optional libraries used to extend on reveal.js
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
                    { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
                ]
            });

        </script>

    </body>
</html>
